---
layout: post
title: Face Tracking &ndash; Kinect 4 Windows v2
date: 2014-08-17 17:33
author: peted70
comments: true
categories: [Kinect, Rx, WinRT]
---
<p> Since working on the <a href="http://www.retail-week.com/stores/store-of-the-week-marks-and-spencer-kalverstraat-amsterdam/5049056.article">virtual rail project</a> I haven’t had much chance to carry out much in the way of Kinect programming. That all changes now since I ordered a Kinect 4 Windows v2 as I have been hacking away over the last few weeks and wanted to share my experiences here. I don’t intend to cover anything introductory so for that please see the Programming for Kinect for Windows v2 Jumpstart videos here <a title="http://channel9.msdn.com/Series/Programming-Kinect-for-Windows-v2" href="http://channel9.msdn.com/Series/Programming-Kinect-for-Windows-v2">http://channel9.msdn.com/Series/Programming-Kinect-for-Windows-v2</a> and also the blog series here <a title="http://mtaulty.com/CommunityServer/blogs/mike_taultys_blog/archive/tags/Kinect/default.aspx" href="http://mtaulty.com/CommunityServer/blogs/mike_taultys_blog/archive/tags/Kinect/default.aspx">http://mtaulty.com/CommunityServer/blogs/mike_taultys_blog/archive/tags/Kinect/default.aspx</a> as Mike takes you right from opening the box to getting dancing skeletons and onwards to whichever direction it takes him.</p> <p>&nbsp;<a href="http://peted.azurewebsites.net/wp-content/uploads/2014/08/WP_20140817_18_39_43_Pro.jpg"><img title="WP_20140817_18_39_43_Pro" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="WP_20140817_18_39_43_Pro" src="http://peted.azurewebsites.net/wp-content/uploads/2014/08/WP_20140817_18_39_43_Pro_thumb.jpg" width="379" height="215"></a></p> <p>I’m going to ease into this gently with a look into face tracking and I’m going to start out with Managed c# code within a Windows Store application but I suspect that this might change as I learn how best to translate the concepts over to native c++ code. I have been re-learning c++ for a while now and have taken the opportunity also to look into DirectX 11 so I expect a lot of my future samples to go in this direction.</p> <h3>Kinect Sensor</h3> <p>To get the sensor started you will need to install the Kinect for Windows SDK 2.0 Public Preview from <a href="http://www.microsoft.com/en-us/download/details.aspx?id=43661">here</a>. You will need to have references to two WinRT components; WindowsPreview.Kinect and Microsoft.Kinect.Face. These are distributed as extension SDKs and can be added via the Add Reference dialog under Extensions. Also, you will need to select a processor architecture for the project as “Any CPU” is not supported (x86 leaves the visual studio designer working correctly). Also, you will need to remember to set the Windows Store app capabilities to include microphone and web cam.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/08/references.png"><img title="references" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; float: none; margin-left: auto; display: block; border-top-width: 0px; margin-right: auto" border="0" alt="references" src="http://peted.azurewebsites.net/wp-content/uploads/2014/08/references_thumb.png" width="678" height="296"></a> For an event-based program the general pattern is get a KinectSensor object, open a reader object for a data stream, subscribe to events for when the data arrives and finally call Open on the sensor object. Here is a very simple example:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:530b6acf-afbe-44a3-8391-5906227de0d6" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">KinectSensor</span><span style="background:#1e1e1e;color:#dcdcdc"> _kinect </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">KinectSensor</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Default;</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">void</span><span style="background:#1e1e1e;color:#dcdcdc"> StartKinect()</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Open Kinect-stream</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">_kinect</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Open();</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Open readers</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">_colorReader </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> _kinect</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">ColorFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">OpenReader();</span></li> <li class="le-pavsc-even">&nbsp;</li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Hook-up frame arrived events</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">_colorReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameArrived </span><span style="background:#1e1e1e;color:#b4b4b4">+=</span><span style="background:#1e1e1e;color:#dcdcdc"> OnColorFrameArrivedHandler;</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">void</span><span style="background:#1e1e1e;color:#dcdcdc"> OnColorFrameArrivedHandler(</span><span style="background:#1e1e1e;color:#569cd6">object</span><span style="background:#1e1e1e;color:#dcdcdc"> sender, </span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrameArrivedEventArgs</span><span style="background:#1e1e1e;color:#dcdcdc"> e)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Retrieve frame reference</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrameReference</span><span style="background:#1e1e1e;color:#dcdcdc"> colorRef </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> e</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameReference;</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Acquire the color frame</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">using</span><span style="background:#1e1e1e;color:#dcdcdc"> (</span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrame</span><span style="background:#1e1e1e;color:#dcdcdc"> colorFrame </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> colorRef</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AcquireFrame())</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Check if frame is still valid</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (colorFrame </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">) </span><span style="background:#1e1e1e;color:#569cd6">return</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Process Color-frame</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>&nbsp;</p> <h3>Reactive Extensions</h3> <p>For me, Reactive Extensions is a natural fit for Kinect programming in an event driven application as it removes the need to think about the mechanics of how to compose and orchestrate the associated event streams. A similar example to that above but using Rx shows how to subscribe to an Observable and shows how to specify which threading context the subscription and event delivery should occur on.</p> <p>&nbsp;</p> <p></p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:53d7e6c4-66f3-4a1d-8e86-cbe5e420e215" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">KinectSensor</span><span style="background:#1e1e1e;color:#dcdcdc"> _kinect </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">KinectSensor</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Default;</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrameReader</span><span style="background:#1e1e1e;color:#dcdcdc"> _colorReader;</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">void</span><span style="background:#1e1e1e;color:#dcdcdc"> StartKinect()</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Open Kinect-stream</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">_kinect</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Open();</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Open readers</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">_colorReader </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> _kinect</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">ColorFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">OpenReader();</span></li> <li class="le-pavsc-even">&nbsp;</li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> colorFrames </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">Observable</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FromEvent</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrameArrivedEventArgs</span><span style="background:#1e1e1e;color:#b4b4b4">&gt;</span><span style="background:#1e1e1e;color:#dcdcdc">(</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc">ev </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> { _colorReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameArrived </span><span style="background:#1e1e1e;color:#b4b4b4">+=</span><span style="background:#1e1e1e;color:#dcdcdc"> (s, e) </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> ev(e); },</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc">ev </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> { _colorReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameArrived </span><span style="background:#1e1e1e;color:#b4b4b4">-=</span><span style="background:#1e1e1e;color:#dcdcdc"> (s, e) </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> ev(e); })</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">SubscribeOn(</span><span style="background:#1e1e1e;color:#4ec9b0">Scheduler</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">TaskPool)</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">ObserveOn(</span><span style="background:#1e1e1e;color:#4ec9b0">Scheduler</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">TaskPool);</span></li> <li class="le-pavsc-even">&nbsp;</li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b8d7a3">IDisposable</span><span style="background:#1e1e1e;color:#dcdcdc"> disp </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> colorFrames</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Subscribe(OnColorFrame);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">private</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">void</span><span style="background:#1e1e1e;color:#dcdcdc"> OnColorFrame(</span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrameArrivedEventArgs</span><span style="background:#1e1e1e;color:#dcdcdc"> e)</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Retrieve frame reference</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrameReference</span><span style="background:#1e1e1e;color:#dcdcdc"> colorRef </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> e</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameReference;</span></li> <li class="le-pavsc-even">&nbsp;</li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Acquire the color frame</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">using</span><span style="background:#1e1e1e;color:#dcdcdc"> (</span><span style="background:#1e1e1e;color:#4ec9b0">ColorFrame</span><span style="background:#1e1e1e;color:#dcdcdc"> colorFrame </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> colorRef</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AcquireFrame())</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Check if frame is still valid</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (colorFrame </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">) </span><span style="background:#1e1e1e;color:#569cd6">return</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even">&nbsp;</li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Process Color-frame</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>Rx is available as a nuget package – so install into your app and you should be good to go:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/08/rxnuget.png"><img title="rx-nuget" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; float: none; margin-left: auto; display: block; border-top-width: 0px; margin-right: auto" border="0" alt="rx-nuget" src="http://peted.azurewebsites.net/wp-content/uploads/2014/08/rxnuget_thumb.png" width="809" height="409"></a></p> <h3>Face Detection</h3> <p>It is necessary to use the tracking ID of the body to start the face tracking and also I will need to get colour frames (so we can see the face). As a result I will use a <a href="http://msdn.microsoft.com/en-us/library/microsoft.kinect.multisourceframereader.aspx">MultiSourceFrameReader</a> which I will ask to deliver body and colour frames in the same event (at the same time). The body data will contain the skeletons in the camera’s view but we just require to get a tracking ID from he body data which is required for face tracking. The colour frames will be copied into a WriteableBitmap for display.&nbsp;&nbsp; </p> <p>&nbsp;</p> <p>So with the preparation work done we need to reference the Face library</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:cdbd02a6-7e26-4e7d-8b23-41a866844566" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc">_frameSource </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">new</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">FaceFrameSource</span><span style="background:#1e1e1e;color:#dcdcdc">(_kinect, </span><span style="background:#1e1e1e;color:#b5cea8">0</span><span style="background:#1e1e1e;color:#dcdcdc">, </span><span style="background:#1e1e1e;color:#b8d7a3">FaceFrameFeatures</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">BoundingBoxInColorSpace </span><span style="background:#1e1e1e;color:#b4b4b4">|</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b8d7a3">FaceFrameFeatures</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FaceEngagement </span><span style="background:#1e1e1e;color:#b4b4b4">|</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b8d7a3">FaceFrameFeatures</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Happy);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">_faceFrameReader </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> _frameSource</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">OpenReader();</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> faceFrames </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">Observable</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FromEvent</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#4ec9b0">FaceFrameArrivedEventArgs</span><span style="background:#1e1e1e;color:#b4b4b4">&gt;</span><span style="background:#1e1e1e;color:#dcdcdc">(</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">ev </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> { _faceFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameArrived </span><span style="background:#1e1e1e;color:#b4b4b4">+=</span><span style="background:#1e1e1e;color:#dcdcdc"> (s, e) </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> ev(e); },</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">ev </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> { _faceFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameArrived </span><span style="background:#1e1e1e;color:#b4b4b4">-=</span><span style="background:#1e1e1e;color:#dcdcdc"> (s, e) </span><span style="background:#1e1e1e;color:#b4b4b4">=&gt;</span><span style="background:#1e1e1e;color:#dcdcdc"> ev(e); })</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">SubscribeOn(</span><span style="background:#1e1e1e;color:#4ec9b0">Scheduler</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">TaskPool)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">ObserveOn(Dispatcher);</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">_faceFrameSubscription </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> faceFrames</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Subscribe(OnFaceFrames);</span></li> </ol> </div> </div> </div> <p></p> <p>Using a similar pattern to the multi-frame reader we can subscribe to events on a FaceFrameSource object and specify the data we are interested in. I have subscribed for a face bounding box, whether the face is ‘engaged’ with the Kinect and whether the face is happy or not. </p> <p>Now the general pattern for the event handlers is as follows:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:45b1604d-0df0-43ea-953a-767873c5fdde" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// using pattern to dispose frames as soon as possible</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">using</span><span style="background:#1e1e1e;color:#dcdcdc"> (</span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> frame </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> args</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameReference</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AcquireFrame())</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (frame </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Copy required data </span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Schedule further processing..</span></li> </ol> </div> </div> </div> <p>so we hang onto the frame for as short a time period as possible.</p> <p>For the Face frame handler I will hook up the data for the bounding box to a display rectangle and whether the face is happy and/or engaged with the camera will be represented by some simple ui controls.</p> <p>Here’s a screenshot of the resulting sample running:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/08/screenshot.png"><img title="screenshot" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="screenshot" src="http://peted.azurewebsites.net/wp-content/uploads/2014/08/screenshot_thumb.png" width="655" height="554"></a> </p> <p>Sample project can be downloaded here <a title="http://1drv.ms/1uJ9bFV" href="http://1drv.ms/1uJ9bFV">http://1drv.ms/1uJ9bFV</a></p>
