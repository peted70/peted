---
layout: single
title: Microsoft Health API - UWP Sample
date: 2015-07-13 18:34
author_profile: true
comments: true
categories: [band, Microsoft, MS Band, universal, uwp, UWP, win10, windows, WinRT]
header:
    teaserlogo: 'assets/images/'
    teaser: 'assets/images/'
---
<p><a href="{{ site.baseurl }}/assets/images/2015/07/MSBand.png"><img title="MSBand" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="MSBand" src="{{ site.baseurl }}/assets/images/2015/07/MSBand_thumb.png" width="728" height="499"></a></p> <p>A few days ago some updates to the Microsoft Band ecosystem were announced including <strong>Microsoft Band Web Tiles Preview</strong> and <strong>Microsoft Health Cloud APIs Preview </strong>for full details see this<strong> </strong><a href="http://lumiaconversations.microsoft.com/2015/07/09/microsoft-band-and-microsoft-health-introduces-web-tiles-and-microsoft-health-cloud-apis/"><strong>blog post</strong></a><strong>. </strong>It’s also worth checking out the<strong> </strong><a href="http://developer.microsoftband.com/"><strong>Microsoft Health developer site</strong></a><strong> </strong>which has all of the details about developing for the band including getting the sensor data in real-time and also communicating to and from the band over Bluetooth.</p> <p>Up until now it hasn’t been possible to consume personal data such as GPS data, sleep quality data, etc. but the Health API Preview provides a RESTful API for accessing this data. The model is that the band stores the data locally and then sync’s it with the Microsoft Health application - which is available for iOS, Android and Windows Phone (linked here <a title="https://www.microsoft.com/microsoft-health/en-gb" href="https://www.microsoft.com/microsoft-health/en-gb">https://www.microsoft.com/microsoft-health/en-gb</a>). Your phone will sync the data from the band up to the cloud approximately every thirty minutes although you can open the Microsoft Health app and sync the data ‘manually’ whenever you like. Similar data is available via your Microsoft Health dashboard <a title="https://dashboard.microsofthealth.com/#/" href="https://dashboard.microsofthealth.com/#/">https://dashboard.microsofthealth.com/#/</a> after signing in with your Microsoft Account.</p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/dashboard.png"><img title="dashboard" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="dashboard" src="{{ site.baseurl }}/assets/images/2015/07/dashboard_thumb.png" width="733" height="512"></a></p> <p>&nbsp;</p> <p>The purpose of this post is to explore the Health API Preview and show how we can create a <a href="https://msdn.microsoft.com/en-us/library/windows/apps/dn609832.aspx#UAPGetStarted">Universal Windows Platform</a> application that consumes them.</p> <p>To get started we need to understand the auth model used which is OAuth 2.0 using the Authorization Grant flow – you can read the OAuth 2.o spec here <a title="http://tools.ietf.org/html/rfc6749" href="http://tools.ietf.org/html/rfc6749">http://tools.ietf.org/html/rfc6749</a> and https is used to encrypt the data in transit. </p> <p>Here’s a visualisation of the auth flow (from the OAuth spec)</p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/auth-flow.png"><img title="auth flow" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="auth flow" src="{{ site.baseurl }}/assets/images/2015/07/auth-flow_thumb.png" width="724" height="439"></a>&nbsp;</p> <p>To create a UWP client you can follow the guide here <a href="https://msdn.microsoft.com/en-us/library/windows/apps/dn609832.aspx#UAPGetStarted">Universal Windows Platform</a> to configure your development environment. Once you are setup you can use Visual Studio to create a Blank Universal Windows project.</p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/createuwpproj.png"><img title="createuwpproj" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="createuwpproj" src="{{ site.baseurl }}/assets/images/2015/07/createuwpproj_thumb.png" width="728" height="508"></a></p> <p>&nbsp;</p> <p>First we need to get an auth token to give us access to the APIs</p> <p>The first step in that is to register an application at the Microsoft account developer center <a title="https://account.live.com/developers/applications" href="https://account.live.com/developers/applications">https://account.live.com/developers/applications</a></p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/createdevapp.png"><img title="createdevapp" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="createdevapp" src="{{ site.baseurl }}/assets/images/2015/07/createdevapp_thumb.png" width="545" height="619"></a></p> <blockquote> <p>For full instructions on setting this up see <a title="http://developer.microsofthealth.com/Content/docs/MS%20Health%20API%20Getting%20Started.pdf" href="http://developer.microsofthealth.com/Content/docs/MS%20Health%20API%20Getting%20Started.pdf">http://developer.microsofthealth.com/Content/docs/MS%20Health%20API%20Getting%20Started.pdf</a></p></blockquote> <p><a href="{{ site.baseurl }}/assets/images/2015/07/configapp.png"><img title="configapp" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="configapp" src="{{ site.baseurl }}/assets/images/2015/07/configapp_thumb.png" width="700" height="587"></a></p> <p>&nbsp;</p> <blockquote> <p>You can fill in some basic information about your app here although this is not mandatory.</p></blockquote> <p>Here’s a summary of the settings I used for the sample app</p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/app-settings.png"><img title="app settings" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="app settings" src="{{ site.baseurl }}/assets/images/2015/07/app-settings_thumb.png" width="311" height="563"></a></p> <p>In the <strong>App Settings </strong>section you can get your Client Id and your Client Secret which you will need for the auth calls that the app will make. So the first step in that is to get an authorization code (which will be used to retrieve an OAuth access token). To do this I used the <a href="https://msdn.microsoft.com/en-us/library/windows/apps/windows.security.authentication.web.webauthenticationbroker.aspx">Web Authentication Broker</a> which handles requesting user permission from the authorization server which might otherwise involve you hosting a WebView control in your app and handling the redirects to and from your app and the server. There is a useful guide to help understanding and diagnosing issues with the Web Authentication Broker here <a title="https://msdn.microsoft.com/en-us/library/windows/apps/xaml/hh750287.aspx" href="https://msdn.microsoft.com/en-us/library/windows/apps/xaml/hh750287.aspx">https://msdn.microsoft.com/en-us/library/windows/apps/xaml/hh750287.aspx</a>. </p> <p>Here’s the code:</p><script src="https://gist.github.com/peted70/73297ec1b0b527e33fa8.js"></script> <p>The WebAuthenticationBroker will redirect the user to login using a Microsoft account and then will prompt them to allow or deny access to the scopes requested:</p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/authenticate.png"><img title="authenticate" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="authenticate" src="{{ site.baseurl }}/assets/images/2015/07/authenticate_thumb.png" width="749" height="581"></a></p> <p><a href="{{ site.baseurl }}/assets/images/2015/07/authorize.png"><img title="authorize" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="authorize" src="{{ site.baseurl }}/assets/images/2015/07/authorize_thumb.png" width="736" height="574"></a></p> <p>If the user successfully authenticates and then allows the permissions the WebAuthenticationBroker will complete and return the authentication code to the app. Once the code is retrieved it can be used to request an access token (and refresh token):<script src="https://gist.github.com/peted70/77dd22780020f4b88aec.js"></script>  <blockquote> <p>Note. the sample app uses password vault to securely store the tokens on the client. It does the same with the Client Id and Client Secret for which it will prompt on the first run and subsequently store. The credentials can be viewed and removed using the Windows Credential Manager.</p></blockquote> <p><a href="{{ site.baseurl }}/assets/images/2015/07/credential-manager.png"><img title="credential manager" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="credential manager" src="{{ site.baseurl }}/assets/images/2015/07/credential-manager_thumb.png" width="714" height="238"></a></p> <p>If any subsequent API calls return Unauthorised the sample will assume that the token has expired and retrieve another using the refresh token, it will then re-issue the API call with the new token.</p> <h2>Health API Calls</h2> <p>The sample app (source code on Github here <a title="https://github.com/peted70/MSHealthAPIClient" href="https://github.com/peted70/MSHealthAPIClient">https://github.com/peted70/MSHealthAPIClient</a>) calls a selection of APIs and displays the JSON returned. I have included sample requests for:</p> <blockquote> <p>Profile</p> <p>Devices</p> <p>Summaries</p> <p>Activities</p></blockquote> <p><a href="{{ site.baseurl }}/assets/images/2015/07/app-screenshot.png"><img title="app screenshot" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="app screenshot" src="{{ site.baseurl }}/assets/images/2015/07/app-screenshot_thumb.png" width="736" height="580"></a></p> <p>See the docs <a title="http://developer.microsofthealth.com/Content/docs/MS%20Health%20API%20Getting%20Started.pdf" href="http://developer.microsofthealth.com/Content/docs/MS%20Health%20API%20Getting%20Started.pdf">http://developer.microsofthealth.com/Content/docs/MS%20Health%20API%20Getting%20Started.pdf</a> for full API details.</p>
