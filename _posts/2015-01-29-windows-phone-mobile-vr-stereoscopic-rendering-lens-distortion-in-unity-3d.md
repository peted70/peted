---
layout: single
title: Windows Phone Mobile VR (Stereoscopic Rendering + Lens Distortion in Unity 3D)
date: 2015-01-29 14:20
author: peted70
comments: true
categories: [headset, mobile vr, Unity, visr, VR, Windows Phone, windows phone]
---
<p>As mentioned in the previous post <a title="http://peted.azurewebsites.net/windows-phone-mobile-vr-gyro-head-tracking-in-unity3d/" href="http://peted.azurewebsites.net/windows-phone-mobile-vr-gyro-head-tracking-in-unity3d/" target="_blank">Windows Phone Mobile VR (Gyro Head Tracking in Unity3D)</a> I will look at stereoscopic rendering and removing the lens distortion effect so that I can run the demo inside my <strong>ViSR </strong>headset. See the kickstarter campaign here <a title="https://www.kickstarter.com/projects/1122924030/visr-virtual-reality/description" href="https://www.kickstarter.com/projects/1122924030/visr-virtual-reality/description">https://www.kickstarter.com/projects/1122924030/visr-virtual-reality/description</a> . This is a great mobile vr headset – definitely worth backing the kickstarter if you are interested in mobile vr.</p> <p>From my previous post</p> <blockquote> <p>“The basic idea behind how this works is that each eye receives a 2d image of a 3d perspective view which are rendered offset from each other. The brain assembles these projections from the retina giving the illusion of depth.”</p></blockquote> <blockquote> <p>“The lenses allow a much wider field of vision but they also distort the image. These factors result in the need to render your 3D scene twice, side-by-side each from a slightly different viewpoints and also to render it in such a way as to ‘undo’ the lens distortion and keep any straight lines looking straight.” </p></blockquote> <p>The two projections will be created using ‘stereoscopic rendering’ and barrel distortion will be used to correct the lens distortion.</p> <p>The first thing I did, of course was to look around the internet to see if I could find a mobile VR SDK which already had windows phone support – ideally a Unity extension that I could drop onto my character controller which would make everything just work. My search didn’t turn up with anything directly applicable so instead I looked around to see if I could find anything close that I could repurpose. I found a few projects with Android/iOS support but decided to use <a title="http://www.alpsvr.com/" href="http://www.alpsvr.com/">ALPS VR</a> which seemed to have everything I needed aside from Windows Phone Gyro support (luckily, I have a solution for that in my <a href="http://peted.azurewebsites.net/windows-phone-mobile-vr-gyro-head-tracking-in-unity3d/" target="_blank">previous post</a> :-)) </p> <p>First, I downloaded the ALPS unity package and added it to the scene from <a href="https://github.com/peted70/head-tracking-unity">https://github.com/peted70/head-tracking-unity</a> (from my <a href="http://peted.azurewebsites.net/windows-phone-mobile-vr-gyro-head-tracking-in-unity3d/" target="_blank">previous post</a>). I created a new git branch ‘stereoscopic’ and added the ALPS unity package to the Unity project. At this point the project won’t compile for windows phone so the next step is to fix this up;. mainly this consisted of #ifdefs and stubbing things out. The Unity package contains a prefab called ALPSCamera which contains everything required to generate the scene hierarchy required for the stereoscopic rendering and barrel distortion correction at run time. So I dropped it into a scene with the same terrain that I used before.</p> <p>The initial scene now looks like this:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/initialscene.png"><img title="initial scene" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="initial scene" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/initialscene_thumb.png" width="737" height="416"></a> </p> <h3>ALPSController</h3> <p>The main script ALSPController is attached to the prefab and creates the scene hierarchy shown below:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/logicalhierarchy.png"><img title="logical hierarchy" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="logical hierarchy" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/logicalhierarchy_thumb.png" width="741" height="563"></a> </p> <p>The viewer’s head is modelled with the Head GameObject to which is attached the HeadTrack script from my <a href="http://peted.azurewebsites.net/windows-phone-mobile-vr-gyro-head-tracking-in-unity3d/" target="_blank">previous post</a> so that we can use Windows Phone. Two GameObjects are created as children of the head and these represent the view from each eye (CameraLeft and CameraRight). Each ALPSCamera script creates and draws a mesh which undoes the barrel distortion. The meshes are rendered side-by-side onto the main texture as can be seen below:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/PrefabHierarchy.png"><img title="Prefab Hierarchy" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="Prefab Hierarchy" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/PrefabHierarchy_thumb.png" width="735" height="333"></a>&nbsp;&nbsp; </p> <p>So, let’s take a look at the scripts attached to the prefab:</p> <h3><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/ALPSControllerEditor.png"><img title="ALPS Controller Editor" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="ALPS Controller Editor" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/ALPSControllerEditor_thumb.png" width="741" height="375"></a> </h3> <p>The ALPSController script has an editor in which you can choose some presets for the device you are using; there are presets for various mobile VR headsets. There is a list of associated parameters:</p> <p>IPD – this is a measurement of the distance between the pupils of the viewer</p> <p>ILD – this is a measurement of the distance between the lenses</p> <p>Barrel Distortion parameters – this allows input of the parameters which define the barrel distortion and should be set to match the lenses in use</p> <p>Chromatic correction</p> <p>(see <a title="http://en.wikipedia.org/wiki/Distortion_(optics)" href="http://en.wikipedia.org/wiki/Distortion_(optics)">http://en.wikipedia.org/wiki/Distortion_(optics)</a> for a description of barrel distortion and chromatic aberration).</p> <p>A shader is used on the textures to correct the chromatic aberration.</p> <h3>ALPSNavigation</h3> <p>This provides translation for the viewpoint and uses a scheme which moves dependent on the angle of the head. I used an on-screen button on the phone in my previous post but obviously this would not be available when using a headset. I’d like to explore using a bluetooth connection to another phone or gamepad to provide the movement.</p> <h3>Character Controller</h3> <p>This is the standard Unity Character Controller and provides the code for actually moving the viewpoint.</p> <p>&nbsp;</p> <p>Here is the result running on a Lumia 930 with the <a href="https://www.kickstarter.com/projects/1122924030/visr-virtual-reality/description" target="_blank">ViSR headset</a>:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/WP_20150129_14_01_03_Pro.jpg"><img title="WP_20150129_14_01_03_Pro" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="WP_20150129_14_01_03_Pro" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/WP_20150129_14_01_03_Pro_thumb.jpg" width="737" height="417"></a> </p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/visrview.jpg"><img title="visrview" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="visrview" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/visrview_thumb.jpg" width="734" height="414"></a></p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2015/01/visr.jpg"><img title="visr" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="visr" src="http://peted.azurewebsites.net/wp-content/uploads/2015/01/visr_thumb.jpg" width="735" height="416"></a>&nbsp; </p> <p>The sample Unity project is on Github here <a href="https://github.com/peted70/head-tracking-unity">https://github.com/peted70/head-tracking-unity</a> in the ‘stereoscopic’ branch.
