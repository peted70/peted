---
layout: post
title: metro app and kinect voice control
date: 2012-10-12 17:11
author: peted70
comments: true
categories: [kinect, Kinect, metro, Metro, streamsocket, win8, Windows 8, winrt, WinRT]
---
<p>Peter Daukintis</p>  <p>Recently I had a need to reacquaint myself with the latest Kinect SDK. v1.6 has just been released and is downloadable from here <a href="http://www.microsoft.com/en-us/kinectforwindows/develop/developer-downloads.aspx" target="_blank">Kinect SDK</a>. So I downloaded it and started playing around with some code and it occurred to me that what I would really like was an environment in which I could use the Kinect in a metro application. Using the Kinect SDK from a metro app is not a supported scenario and neither is communication between a metro app and a desktop app. Having said that, I recall reading somewhere that someone may have used a wcf service to carry out this communication so I guessed that a local socket connection would probably work (I believe this is an unsupported mechanism and would likely fail store certification). My goal was not to release an app but just to be able to make use of it for experimental/personal usage. </p>  <p>Now, I had previously written some WinRT code for socket communication using StreamSocket (see <a href="http://babaandthepigman.wordpress.com/2012/04/07/streamsocket-example-c-metro/" target="_blank">StreamSocket Example</a>) and I saw a few blog posts about using WinRT libraries on the Windows 8 desktop so I though I’d give it a try…</p>  <p>The first thing was to get a communication path between a metro app and windows 8 desktop app. I followed the instructions <a href="http://www.codeproject.com/Articles/457335/How-to-call-WinRT-APIs-from-NET-desktop-apps" target="_blank">here</a> to enable WinRT in a desktop app. Then, I copied the server side of the socket code and the xaml into a WPF app. With a few minor adjustments (replacing OnNavigatedTo event handler and MessageDialog) it was good to go..</p>  <p>&#160;</p>  <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2012/10/wpfapp.png"><img style="background-image:none;padding-left:0;padding-right:0;display:block;float:none;margin-left:auto;margin-right:auto;padding-top:0;border-width:0;" title="wpfapp" border="0" alt="wpfapp" src="http://peted.azurewebsites.net/wp-content/uploads/2012/10/wpfapp_thumb.png" width="662" height="179" /></a></p>  <p>To test that everything worked ok, I </p>  <ul>   <li>Ran the wpf application in the debugger… </li>    <li>Ran the store ui app in the debugger </li>    <li>Listen from the desktop </li>    <li>Connect from the store ui app </li> </ul>  <p>And….</p>  <p>It worked!</p>  <p>(side by side apps screenshot…)</p>  <p>So, the next step is to configure the wpf application to respond to Kinect voice commands and ship them over the socket.</p>  <p>First I added references to Kinect SDK and toolkit assemblies, which on my machine were located as follows: </p>  <p>C:Program FilesMicrosoft SDKsKinectDeveloper Toolkit v1.6.0SamplesbinMicrosoft.Speech.dll</p>  <p>And </p>  <p>C:Program FilesMicrosoft SDKsKinectv1.6AssembliesMicrosoft.Kinect.dll</p>  <p>Add code to carry out speech recognition using the Kinect with a very simple grammar.</p>  <div style="margin:0;display:inline;float:none;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:7e165134-1067-4cb6-9052-bd722835859a" class="wlWriterEditableSmartContent"> <div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;"> <div style="background-color:#000000;overflow:auto;padding:2px 5px;"><span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">_sre</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#b4b4b4;">=</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#4ec9b0;">SpeechRecognitionEngine</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#ffffff;">recognizer</span><span style="background:#1e1e1e;color:#dcdcdc;">);</span><br> <br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#569cd6;">var</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#ffffff;">gb</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#b4b4b4;">=</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#4ec9b0;">GrammarBuilder</span><span style="background:#1e1e1e;color:#dcdcdc;"> { </span><span style="background:#1e1e1e;color:#ffffff;">Culture</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#b4b4b4;">=</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#ffffff;">recognizer</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Culture</span><span style="background:#1e1e1e;color:#dcdcdc;"> };</span><br> <br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#569cd6;">var</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#ffffff;">choices</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#b4b4b4;">=</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#4ec9b0;">Choices</span><span style="background:#1e1e1e;color:#dcdcdc;">();</span><br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">choices</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Add</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#4ec9b0;">SemanticResultValue</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#d69d85;">&quot;go&quot;</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#d69d85;">&quot;NEXT&quot;</span><span style="background:#1e1e1e;color:#dcdcdc;">));</span><br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">choices</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Add</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#4ec9b0;">SemanticResultValue</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#d69d85;">&quot;back&quot;</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#d69d85;">&quot;PREV&quot;</span><span style="background:#1e1e1e;color:#dcdcdc;">));</span><br> <br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">gb</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Append</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#ffffff;">choices</span><span style="background:#1e1e1e;color:#dcdcdc;">);</span><br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#569cd6;">var</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#ffffff;">g</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#b4b4b4;">=</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#4ec9b0;">Grammar</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#ffffff;">gb</span><span style="background:#1e1e1e;color:#dcdcdc;">);</span><br> <br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">_sre</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">LoadGrammar</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#ffffff;">g</span><span style="background:#1e1e1e;color:#dcdcdc;">);</span><br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">_sre</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">SpeechRecognized</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#b4b4b4;">+=</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#ffffff;">sre_SpeechRecognized</span><span style="background:#1e1e1e;color:#dcdcdc;">;</span><br> <br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">_sre</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">SetInputToAudioStream</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#ffffff;">_kinect</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">AudioSource</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Start</span><span style="background:#1e1e1e;color:#dcdcdc;">(),</span><br>     <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#569cd6;">new</span><span style="background:#1e1e1e;color:#dcdcdc;"> </span><span style="background:#1e1e1e;color:#ffffff;">Microsoft</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Speech</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">AudioFormat</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#4ec9b0;">SpeechAudioFormatInfo</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#b8d7a3;">EncodingFormat</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Pcm</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#b5cea8;">16000</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#b5cea8;">16</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#b5cea8;">1</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#b5cea8;">32000</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#b5cea8;">2</span><span style="background:#1e1e1e;color:#dcdcdc;">, </span><span style="background:#1e1e1e;color:#569cd6;">null</span><span style="background:#1e1e1e;color:#dcdcdc;">));</span><br> <br> <span style="background:#1e1e1e;color:#dcdcdc;"></span><span style="background:#1e1e1e;color:#ffffff;">_sre</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">RecognizeAsync</span><span style="background:#1e1e1e;color:#dcdcdc;">(</span><span style="background:#1e1e1e;color:#b8d7a3;">RecognizeMode</span><span style="background:#1e1e1e;color:#b4b4b4;">.</span><span style="background:#1e1e1e;color:#ffffff;">Multiple</span><span style="background:#1e1e1e;color:#dcdcdc;">);</span></div> </div> </div>  <p>When the speech recognizer recognises the next (go) and previous (back) words I will transmit that text over the socket to the waiting metro app whereupon I will use them to activate commands.</p>  <p>To make a useful (sort of) example I will create a Metro app which loads images from your pictures library into a flip view and use the voice commands to allow navigation of the pictures using 'next'/&quot;previous&quot;.</p>       <a href="http://peted.azurewebsites.net/wp-content/uploads/2012/10/wp_000036.jpg"><img style="background-image:none;border-bottom:0;border-left:0;padding-left:0;padding-right:0;display:block;float:none;margin-left:auto;border-top:0;margin-right:auto;border-right:0;padding-top:0;" title="WP_000036" border="0" alt="WP_000036" src="http://peted.azurewebsites.net/wp-content/uploads/2012/10/wp_000036_thumb.jpg" width="573" height="449" /></a>  <p>&#160;</p>  <p>Disclaimer: Please note that I haven’t tested this code beyond trying it in my development environment and it was not written to be robust in any way.</p>  <p>Download the solutions here.</p>  <p><a href="http://sdrv.ms/QW12JJ" target="_blank">KinectSocketServer</a></p>  <p><a href="http://sdrv.ms/QW1bwX" target="_blank">KinectPictureViewer</a></p>
