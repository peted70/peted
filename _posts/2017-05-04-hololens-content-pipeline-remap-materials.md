---
layout: single
title: HoloLens Content Pipeline (remap materials)
date: 2017-05-04 22:33
author: peted70
comments: true
categories: [3D, blender, c#, editor, HoloLens, HoloLens, HoloToolkit, materials, models, Unity, unity]
---
<p>As with any 3D project it is important when working with HoloLens to understand and streamline the content pipeline from content creation or procurement through to optimised models running inside the final app. If you are creating the assets in-house or have access to the creators and can get them to modify their process then great but this isn’t always going to be the case. Maybe you are building a proof-of-concept and need to source models quickly, possibly by purchasing from an online 3D catalogue or you have access to 3D assets but the creator is no longer available to provide modifications moving forwards.</p> <p>On a HoloLens project when sourcing models from elsewhere the first thing I look to do is to reassign the materials to either optimised custom shaders or those from the <a href="https://github.com/Microsoft/HoloToolkit-Unity" target="_blank">HoloToolkit</a> for Unity. These will ensure that the framerate of your app will be maximised – at least, in terms of fill rate of the display. Now, suppose that you source a model which has a complex hierarchy and a large number of sub-meshes and seams with a lot of materials and material assignments. </p> <blockquote> <p>Here’s an example of a car model I used in a recent project – notice the model hierarchy on the left and the list of materials for one of the selected children shown on the right.</p></blockquote> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/Car.png"><img title="Car" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Car" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/Car_thumb.png" width="746" height="446"></a></p> <p>Going through this ‘by hand’ could be fairly time-consuming. Now suppose that you have been through this by hand and then you determine that the meshes themselves need to be optimised for number of vertices/triangles. You send the original model off to a 3D modeller who sends it back after the optimisation and the process of exporting the model from whichever 3D software is used now recreates materials using Unity standard shaders and you are faced with the task of remapping all of the <a href="https://github.com/Microsoft/HoloToolkit-Unity" target="_blank">HoloToolkit</a> shaders again. </p> <p>Luckily Unity provides a way to remap the materials by having it search for matching materials by name on import. To illustrate, I created a cube, extruded one face a few times and applied different materials to each section like this:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/cubematerials.png"><img title="cubematerials" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="cubematerials" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/cubematerials_thumb.png" width="731" height="510"></a></p> <p>&nbsp;</p> <p>I named the materials purple, yellow, green and blue respectively. I exported the model as an FBX file and dragged it into the Unity assets folder. This brings the model in as a prefab with a materials folder alongside like this:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image_thumb.png" width="743" height="453"></a></p> <p>There is a material generated for each of the purple, yellow, green and blue materials. If you select the model prefab the inspector will show some settings useful to control how the materials are imported.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image1.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image_thumb1.png" width="739" height="891"></a></p> <p>These settings allow you to define a set of materials elsewhere in your project that will be mapped to those on the prefab instead of the auto-generated ones. I created a Materials folder and created some new materials using the naming convention shown below:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image2.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image_thumb2.png" width="749" height="169"></a></p> <p>I then changed the Prefab Model settings for the <strong>Material Naming</strong> setting to use ‘Model Name + Model’s Material’ and I changed the <strong>Material Search </strong>setting to ‘project wide’ and the result is shown here:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image3.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image_thumb3.png" width="735" height="643"></a></p> <blockquote> <p>You can find the Unity docs for this feature here <a title="https://docs.unity3d.com/530/Documentation/Manual/HOWTO-importObject.html" href="https://docs.unity3d.com/530/Documentation/Manual/HOWTO-importObject.html">https://docs.unity3d.com/530/Documentation/Manual/HOWTO-importObject.html</a></p></blockquote> <p>My prefab takes the materials I defined in my project so in my scenario I could define my HoloToolkit shader materials here andjust reload any updated FBX files and they will have the correct materials. This is great but in my particular scenario I had a lot of materials that were all exactly the same but with different names so for me it would have been more flexible to have been able to define a many to one mapping which can’t really be done by matching names.</p> <p>Fortunately, it is very easy to extend Unity and so I could simply write some code to generate the mapping that I wanted and be able to save and load those mappings as required.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image4.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image_thumb4.png" width="732" height="331"></a>&nbsp;</p> <p>To create a Unity menu item as shown the following code was used:</p><script src="https://gist.github.com/peted70/876dcac6259f85e038023a8633b25f41.js"></script> <p>&nbsp;</p> <p>And the following function shows how the materials were replaced:</p><script src="https://gist.github.com/peted70/66914bebf929a975ce14c2effb7cc605.js"></script> <p>To illustrate usage I have loaded the original car model from above and created a new material with a purple colour called ‘purple’ and have used my custom editor tool to remap all of the blue paint materials to the purple material.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image5.png"><img title="image" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="image" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/image_thumb5.png" width="732" height="852"></a></p> <p>When clicking the Apply button the materials get replaced and you also have the option to save/load the mapping. Here’s a summary of what the tool actually does:</p> <blockquote> <p>- enumerates the materials on the ‘selected’ item and display a label for each (I selected the whole car in my example)</p> <p>- create a dropdown for each labelled material containing all materials in the project</p> <p>- when Apply clicked build the mapping in code and apply the material changes</p></blockquote> <p>&nbsp;</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2017/05/carmapped.png"><img title="carmapped" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="carmapped" src="http://peted.azurewebsites.net/wp-content/uploads/2017/05/carmapped_thumb.png" width="735" height="433"></a></p> <p>Its a bit rough around the edges but serves a purpose and the source code is provided here <a title="https://github.com/peted70/hololens-map-material" href="https://github.com/peted70/hololens-map-material">https://github.com/peted70/hololens-map-material</a></p>
