---
layout: post
title: Kinect 4 Windows V2 &ndash; Unity 3D
date: 2014-10-27 17:05
author: peted70
comments: true
categories: [Kinect]
---
<p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/unityparticles.png"><img title="unityparticles" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="unityparticles" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/unityparticles_thumb.png" width="904" height="574"></a> </p> <p>After installing the Kinect v2 SDK from here <a title="http://www.microsoft.com/en-us/download/details.aspx?id=44561" href="http://www.microsoft.com/en-us/download/details.aspx?id=44561">http://www.microsoft.com/en-us/download/details.aspx?id=44561</a> you can also download the supporting Unity 3D plugins here <a href="http://go.microsoft.com/fwlink/?LinkID=513177">http://go.microsoft.com/fwlink/?LinkID=513177</a>. Note that the plugins require Unity 3D Pro and they expose APIs for Kinect for Windows core functionality, visual gesture builder and face to Unity apps. The zip file containing the Unity packages also contains two sample scenes Green Screen and Kinect View. Lets take a look at KinectView first:</p> <p>&nbsp;</p> <p>So, I stumbled around a bit on the next step as initially I tried opening the KinectView scene from it’s existing location and this doesn’t seem to work very well. The result I got was that when I examined the game objects there was an error on each of the scripts. After some head-scratching I watched the video here <a title="http://channel9.msdn.com/Series/Programming-Kinect-for-Windows-v2/04" href="http://channel9.msdn.com/Series/Programming-Kinect-for-Windows-v2/04">http://channel9.msdn.com/Series/Programming-Kinect-for-Windows-v2/04</a> and at about 10:54 the presenter shows copying the scene locally to the current project. That fixed the issue for me so I was back up and running. You can plug in your Kinect sensor and run the game and then explore the scripts to see how the data is retrieved from the sensor and applied to GameObjects in your scene.</p> <p>&nbsp;</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/kinectview.png"><img title="kinectview" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="kinectview" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/kinectview_thumb.png" width="885" height="500"></a>&nbsp; </p> <p></p> <p>My idea was to create a very simple Kinect sample which will move particle systems around following the positions of the users hands. So lets step through what I did. </p> <p>First, I chose File &gt; New Project to bring up the Unity project wizard:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/projwiz.png"><img title="projwiz" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="projwiz" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/projwiz_thumb.png" width="657" height="420"></a> </p> <p>I added the Visual Studio Tools as I’m more comfortable editing and debugging in Visual Studio. You can download the tools from here <a title="https://visualstudiogallery.msdn.microsoft.com/20b80b8c-659b-45ef-96c1-437828fe7cf2" href="https://visualstudiogallery.msdn.microsoft.com/20b80b8c-659b-45ef-96c1-437828fe7cf2">https://visualstudiogallery.msdn.microsoft.com/20b80b8c-659b-45ef-96c1-437828fe7cf2</a>.</p> <p>Once the project is created I imported the Kinect Unity package; Assets &gt; Import Package &gt; Custom Package… I navigated to where I installed the Kinect package and chose Kinect.2.0.1410.19000.unitypackage.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/import.png"><img title="import" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="import" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/import_thumb.png" width="654" height="367"></a> </p> <p>I left everything selected and imported the various libraries and scripts. The editor shows that I have an empty scene just containing a Camera.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/emptyscene.png"><img title="emptyscene" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="emptyscene" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/emptyscene_thumb.png" width="652" height="277"></a> </p> <p>The first thing to do was to try to get the Kinect sensor data into the scene, so to do this I created a new c# script in the project and copied the code from the KinectView sample in the file BodySourceManager.cs. The code retrieves the sensor and opens a reader on it for the body data and also reads the current frame’s data in the scripts update() method. The update() method is called as part of the game loop so we are ‘pulling’ the Kinect skeleton data each time we are called. The class also has a method GetData() to allow the data to be accessed by other scripts.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/lefthand.png"><img title="lefthand" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="lefthand" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/lefthand_thumb.png" width="273" height="432"></a> </p> <p>I created an empty GameObject called BodySourceManager and associated the BodySourceManager.cs script with it so the code to set up the Kinect would be executed. Next, I created another empty GameObject and associated a new script which would get the body data and position the GameObject depending on the position of one of the joints in the skeleton. I made the joint type a variable so I could set up the positions of various GameObjects via the Unity editor. The intention was that if I then add a particle system as a child of this new GameObject then it would follow the tracked position of say, the left hand and I could add others for each joint that I wanted to track.</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/10/hierarchy.png"><img title="hierarchy" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="hierarchy" src="http://peted.azurewebsites.net/wp-content/uploads/2014/10/hierarchy_thumb.png" width="872" height="232"></a>The code for the update loop showing how the game object position is set from the joint.&nbsp; </p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:6c4d0bd7-ccf9-4fc1-91c2-9f01b21a3bd5" class="wlWriterEditableSmartContent" style="width: 534px; float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; margin-right: auto"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#569cd6">void</span><span style="background:#1e1e1e;color:#dcdcdc"> Update () </span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (_bodySourceManager </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">return</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">_bodyManager </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> _bodySourceManager</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">GetComponent</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#4ec9b0">BodyManager</span><span style="background:#1e1e1e;color:#b4b4b4">&gt;</span><span style="background:#1e1e1e;color:#dcdcdc">();</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (_bodyManager </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">return</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#4ec9b0">Body</span><span style="background:#1e1e1e;color:#dcdcdc">[] data </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> _bodyManager</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">GetData();</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (data </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">return</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// get the first tracked body...</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">foreach</span><span style="background:#1e1e1e;color:#dcdcdc"> (</span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> body </span><span style="background:#1e1e1e;color:#569cd6">in</span><span style="background:#1e1e1e;color:#dcdcdc"> data)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (body </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>            <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">continue</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (body</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">IsTracked)</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">            <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> pos </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> body</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Joints[_jointType]</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Position;</span></li> <li>           <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">gameObject</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">transform</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">position </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">new</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">Vector3</span><span style="background:#1e1e1e;color:#dcdcdc">(pos</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">X, pos</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Y, pos</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Z);</span></li> <li class="le-pavsc-even">            <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">break</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>The next step was to add two new GameObjects, one for each hand and set their joint types to HandLeft and HandRight and then add particle system’s to each as a child. Then the particle systems had their parameters tweaked until they looked how I wanted. It seems to me that the combination of Unity and Kinect is a pretty powerful one and I’m looking forward to seeing the results in the Windows Store. Please find the sample project here <a title="http://1drv.ms/1tyKlIT" href="http://1drv.ms/1tyKlIT">http://1drv.ms/1tyKlIT</a>. </p>
