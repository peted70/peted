---
layout: post
title: Face Tracking Native &ndash; Kinect 4 Windows v2
date: 2014-08-20 11:56
author: peted70
comments: true
categories: [c++, Kinect, Rx, WinRT]
---
<p>Well, with the managed version working in c# (see <a href="http://peted.azurewebsites.net/face-tracking-kinect-4-windows-v2/" target="_blank">Face Tracking Kinect 4 Windows V2 - Managed</a>) it should be a breeze to convert the code to a native c++ windows store xaml app :).</p> <p>Converting an event-based c#/xaml app seemed like a gentle introduction to a more native environment which I hope to get into later. Also, I was asked recently whether face tracking worked in a native app. </p> <p>There are a few things I’ve become accustomed to in the managed development environment; nuget for one thing and also I’ve been using Reactive extensions in my Kinect projects. A quick Bing-search later and I found this:</p> <p><a href="http://peted.azurewebsites.net/wp-content/uploads/2014/08/rxnugetcpp.png"><img title="rx-nugetcpp" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; float: none; margin-left: auto; display: block; border-top-width: 0px; margin-right: auto" border="0" alt="rx-nugetcpp" src="http://peted.azurewebsites.net/wp-content/uploads/2014/08/rxnugetcpp_thumb.png" width="773" height="334"></a>So, typing Install-Package rxcpp into the Package Manager Console window caused a short flurry of output which I assume meant the packages were downloaded and referenced within my project. After some short experimentation I found that v2.0.0 doesn’t yet have bindings for WinRT so I rolled back to v1.0.2 with a ‘note-to-self’ to explore this more fully later. Including the headers <em>rx.hpp and </em>rx-winrt.hpp in the projects precompiled header and adding a <em>using namespace rxcpp; </em>enabled me to get started writing the code.</p> <p>It took me a while to work out the correct syntax for configuring the Kinect event handlers using Rx. I ended up with this:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:6751432b-1e16-4ff0-a4f2-1b467f728922" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dadada">_multiFrameReader</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#dadada">_kinect</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">OpenMultiSourceFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#4ec9b0">FrameSourceTypes</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#b8d7a3">Body</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">|</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">FrameSourceTypes</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#b8d7a3">Color</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">multiFrameObservable</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">from</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">rxrt</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#c8c8c8">FromEventPattern</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#4ec9b0">MultiFrameArrivedEventHandler</span><span style="background:#1e1e1e;color:#b4b4b4">&gt;(</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">[</span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">](</span><span style="background:#1e1e1e;color:#4ec9b0">MultiFrameArrivedEventHandler</span><span style="background:#1e1e1e;color:#b4b4b4">^</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">h</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">return</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_multiFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">MultiSourceFrameArrived</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">+=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">h</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span><span style="background:#1e1e1e;color:#b4b4b4">,</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">[</span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">](</span><span style="background:#1e1e1e;color:#c8c8c8">Windows</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#c8c8c8">Foundation</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#4ec9b0">EventRegistrationToken</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_multiFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">MultiSourceFrameArrived</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">-=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span><span style="background:#1e1e1e;color:#b4b4b4">))</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#c8c8c8">observe_on</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">std</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#c8c8c8">make_shared</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#c8c8c8">rxcpp</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#4ec9b0">NewThreadScheduler</span><span style="background:#1e1e1e;color:#b4b4b4">&gt;());</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#dadada">_disposables</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#c8c8c8">Add</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">from</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">multiFrameObservable</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#c8c8c8">subscribe</span><span style="background:#1e1e1e;color:#b4b4b4">([</span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">](</span><span style="background:#1e1e1e;color:#569cd6">const</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">rxrt</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#4ec9b0">EventPattern</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#4ec9b0">MultiSourceFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">^,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">MultiSourceFrameArrivedEventArgs</span><span style="background:#1e1e1e;color:#b4b4b4">^&gt;&amp;</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">p</span><span style="background:#1e1e1e;color:#b4b4b4">){</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">this</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">OnMultiFrameArrived</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#7f7f7f">p</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span><span style="background:#1e1e1e;color:#b4b4b4">));</span></li> </ol> </div> </div> </div> <p>In the Kinect event handlers when I tried to call Close() on the Frames I got a compile error error C2039: 'Close' : is not a member of 'WindowsPreview::Kinect::MultiSourceFrame' so I used scoping to release the Frames instead.</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:7f312a6a-815e-4313-842f-98d6f83634fc" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li>{</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">multiFrame</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">p</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#c8c8c8">EventArgs</span><span style="background:#1e1e1e;color:#b4b4b4">()-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">FrameReference</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">AcquireFrame</span><span style="background:#1e1e1e;color:#b4b4b4">();</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">multiFrame</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">nullptr</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>Another difference I introduced to the native version was that I couldn’t find a way to schedule rx to deliver the Kinect events via the Thread Pool so I subscribed to the multi frame event from a Thread Pool thread and used the CurrentThreadScheduler. Aside from these minor differences the rest of the code looked pretty much the same. You can find the sample project here <a title="http://1drv.ms/1th57Lb" href="http://1drv.ms/1th57Lb">http://1drv.ms/1th57Lb</a>.</p>
