---
layout: single
title: Avateering with Kinect V2 &ndash; Joint Orientations
date: 2015-04-06 19:26
author_profile: true
comments: true
categories: [avateer, body, c++, directx, joints, kinect, Kinect, orientation, windows, windows store, WinRT]
header:
    teaserlogo: 'assets/images/'
    teaser: 'assets/images/'
---
<p>For my own learning I wanted to understand the process of using the <strong>Kinect V2</strong> to drive the real-time movement of a character made in 3D modelling software. This post is the first part of that learning which is taking the joint orientations data provided by the Kinect SDK and using that to position and rotate ‘bones’ which I will represent by rendering cubes since this is a very simple way to visualise the data. (I won’t cover smoothing the data or modelling/rigging in this post). So the result should be something similar to the Kinect Evolution Block Man demo which can be discovered using the Kinect SDK browser. </p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/blockman.png"><img title="blockman" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="blockman" src="{{ site.baseurl }}/assets/images/2015/04/blockman_thumb.png" width="724" height="478"></a> </p> <blockquote> <p>To follow this along you would need a working Kinect V2 sensor with USB adapter, a fairly high-specced machine running Windows 8.0/8.1 with USB3 and a DirectX11-compatible GPU and also the Kinect V2 SDK installed. <a href="http://mtaulty.com/CommunityServer/blogs/mike_taultys_blog/archive/2015/02/01/get-set-up-for-kinect-for-windows-v2-development.aspx" target="_blank">Here</a> are some instructions for setting up your environment.&nbsp; </p></blockquote> <p>To back up a little there are two main ways to represent body data from the Kinect; the first being to use the absolute positions provided by the SDK which are values in 3D Camera-space which are measured in metres, the other is to use the joint orientation data to rotate a hierarchy of bones. The latter is the one we will look at here. Now, there is an advantage in using joint orientations and that is, as long as your model has the same overall skeleton structure as the Kinect data then it doesn’t matter so much what the relative sizes of the bones are which frees up the modelling constraints. The SDK has done the job of calculating the rotations from the absolute joint positions for us so let’s explore how we can apply those orientations in code.</p> <h4>Code</h4> <p>I am going to program this by starting with the DirectX and XAML C++ template in Visual Studio which provides a basic DirectX 11 environment, with XAML integration, basic shaders and a cube model described in code. </p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/vstemplate.png"><img title="vstemplate" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="vstemplate" src="{{ site.baseurl }}/assets/images/2015/04/vstemplate_thumb.png" width="729" height="354"></a> </p> <h5>Body Data</h5> <p>Let’s start by getting the body data into our program from the sensor. As always we start with getting a <a href="https://msdn.microsoft.com/en-us/library/windowspreview.kinect.kinectsensor.aspx" target="_blank">KinectSensor</a> object which I will initialise in the Sample3DSceneRenderer class constructor, then we open a <a href="https://msdn.microsoft.com/en-us/library/windowspreview.kinect.bodyframereader.aspx" target="_blank">BodyFrameReader</a> on the <a href="https://msdn.microsoft.com/en-us/library/windowspreview.kinect.bodyframesource.aspx" target="_blank">BodyFrameSource</a>, for which there is a handy property on the KinectSensor object. We hold the sensor object and the reader object as class variables as we don’t want those to fall out of scope. Additionally, we need to create a vector of type Body to store the data supplied by the sensor. Once we have the opened reader object we can use it to pull the latest frame of body data from within out render loop. I’m not modifying the structure of the project template so I am using Sample3DSceneRenderer class and inserting my code into the Render function. So to initialise:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:b313f6ec-cdc9-4d54-afb1-4df7b36bd9e5" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dadada">_sensor</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">KinectSensor</span><span style="background:#1e1e1e;color:#b4b4b4">::</span><span style="background:#1e1e1e;color:#c8c8c8">GetDefault</span><span style="background:#1e1e1e;color:#b4b4b4">();</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#dadada">_reader</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#dadada">_sensor</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">BodyFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">OpenReader</span><span style="background:#1e1e1e;color:#b4b4b4">();</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#dadada">_bodies</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">ref</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">new</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">Vector</span><span style="background:#1e1e1e;color:#b4b4b4">&lt;</span><span style="background:#1e1e1e;color:#4ec9b0">Body</span><span style="background:#1e1e1e;color:#b4b4b4">^&gt;(</span><span style="background:#1e1e1e;color:#dadada">_sensor</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">BodyFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">BodyCount</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#dadada">_sensor</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">Open</span><span style="background:#1e1e1e;color:#b4b4b4">();</span></li> </ol> </div> </div> </div> <p>and from within the Render function:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:f894df63-d4cb-49a6-9a82-eff9e77fc8c5" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li>{</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">bodyFrame</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#dadada">_reader</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">AcquireLatestFrame</span><span style="background:#1e1e1e;color:#b4b4b4">();</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">bodyFrame</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">nullptr</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">bodyFrame</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">GetAndRefreshBodyData</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#dadada">_bodies</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">updated</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">true</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>Note the use of scoping to ensure that the body frame gets closed as soon as possible. Then we can write a loop like this to process the body data:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:1b342a2b-d430-40de-b5de-b58e9d434fbc" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">for</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">body</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">:</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#dadada">_bodies</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">((</span><span style="background:#1e1e1e;color:#4ec9b0">Body</span><span style="background:#1e1e1e;color:#b4b4b4">^)</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">body</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">nullptr</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">||</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">!</span><span style="background:#1e1e1e;color:#c8c8c8">body</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">IsTracked</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">continue</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li>&nbsp;</li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// do stuff here...</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>I read through quite a few discussions on the Kinect SDK forums <a href="https://social.msdn.microsoft.com/Forums/windowsapps/en-US/home?forum=kinectv2sdk" target="_blank">here</a> but I didn’t find anything that I felt provided a clear description of how you could use the joint orientations. The best source was the code for the Block Man demo since it worked well but often key concepts and assumptions can get hidden inside working code so I set about to clear that up in my mind. I felt that I needed a few additional things to help me explore the scenario: an orbit camera to allow orbiting and zooming in a scene, a floor plane grid and some positional markers. I find it really helpful to be able to explore a 3D scene from different angles and also to be able to draw markers at key locations.</p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/scenegrid.png"><img title="scenegrid" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="scenegrid" src="{{ site.baseurl }}/assets/images/2015/04/scenegrid_thumb.png" width="729" height="556"></a>&nbsp;&nbsp;&nbsp;&nbsp; </p> <p></p> <p></p> <p></p> <p></p> <h4>Kinect Joint Hierarchy</h4> <p>The first subject to consider is how the Kinect joint hierarchy is constructed as it is not made explicit in the SDK. Each joint is identified by one of the following enum values:</p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/jointenum.png"><img title="jointenum" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="jointenum" src="{{ site.baseurl }}/assets/images/2015/04/jointenum_thumb.png" width="729" height="723"></a> </p> <p>Starting with the SpineBase which can be considered as the root of the hierarchy we end up with something like this:</p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/hierarchy.png"><img title="hierarchy" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="hierarchy" src="{{ site.baseurl }}/assets/images/2015/04/hierarchy_thumb.png" width="735" height="445"></a> </p> <p></p> <p>Which corresponds to the following skeleton:</p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/kinectskeleton.png"><img title="kinectskeleton" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="kinectskeleton" src="{{ site.baseurl }}/assets/images/2015/04/kinectskeleton_thumb.png" width="623" height="656"></a> </p> <p>I added some utility code to the project to represent this hierarchy – two functions; <strong>CreateBoneHierarchy</strong> and <strong>TraverseBoneHierarchy</strong>. The first creates an in-memory representation of the parent-child relationships between the joints and the second does a depth-first traversal of the hierarchy allowing a function/lambda to be called as each node is traversed. I will use the traversal method to draw and transform each bone in the skeleton.</p> <h4>Bones</h4> <p>To draw each separate bone I modified the original cube model that was supplied with the default project template. I modified the coordinates of the original cube so that one end was at the origin and the other was 4 units in the y-direction; so when rendered without an additional transform it looks like the orange cube below and when rotated 90 degrees looks like the dark blue cube. The point being that the model is not centred on the origin and so won’t rotate about its centre but about its end.</p> <p></p> <p></p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/ROTATEDBONE.png"><img title="ROTATEDBONE" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="ROTATEDBONE" src="{{ site.baseurl }}/assets/images/2015/04/ROTATEDBONE_thumb.png" width="722" height="731"></a> </p> <h5>QuaTernions</h5> <p>I’m not going to delve into quaternions here suffice to say that they are a way to describe an orientation in 3d space and are used to avoid gimbal-lock related problems which arise from using Euler angles for rotation. They provide a great way to store and animate rotations but ultimately are converted back to matrix form and your graphics programming environment most-likely provides functions to do this. See <a href="http://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation" target="_blank">this</a> for further information.</p> <p></p> <h4>Transforming and Rendering</h4> <p>As we traverse the joint hierarchy we need to position our local origin at the end of our parent bone before we apply our local model matrix which will in turn apply the joint orientation rotations and also scale the cube according to which bone it represents. To illustrate this let’s look at the first three bones drawn – note that I also draw a marker at each local origin.</p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/threebonesmu.png"><img title="threebonesmu" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="threebonesmu" src="{{ site.baseurl }}/assets/images/2015/04/threebonesmu_thumb.png" width="712" height="743"></a> </p> <p>Here are the main steps in the render function in pseudocode:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:89b46cb4-5b98-4e48-9610-36a34f88b732" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#57a64a">// Lookup joint orientation data</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">orientation </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> body</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dcdcdc">JointOrientations</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dcdcdc">Lookup</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#dcdcdc">jointType</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#57a64a">// create rotation matrix</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">rotationMatrix </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> matrixFromQuaternion</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#dcdcdc">orientation</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#57a64a">// get our local origin</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">origin </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> parent</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dcdcdc">transformed</span><span style="background:#1e1e1e;color:#b4b4b4">()</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#57a64a">// Draw marker transformed to local origin</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">DrawMarker</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#dcdcdc">origin</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#57a64a">// create model matrix </span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">model </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> scale </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> translate </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> rotate</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#57a64a">// transform position of child local orign and store it</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">transformed </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> model </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> endOfBone</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#57a64a">// Draw bone</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">DrawBone</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#dcdcdc">model</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> </ol> </div> </div> </div> <p>In the actual code this is complicated a little by the following:</p> <blockquote> <p>- The leaf joint orientations are set to zero so the leaf bones just take their parent orientations – this is the same in the Block Man implementation.</p> <p>- If we are at the root we need to transform to the absolute position of the joint (this will position the whole body in camera space)</p></blockquote> <p>Here is the code I used for drawing each bone:</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:0fe20fa6-4e6e-41e3-982a-3db6d6658b15" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Lookup the joint orientation for this joint</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">body</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">JointOrientations</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">Lookup</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">JointType</span><span style="background:#1e1e1e;color:#b4b4b4">());</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// if orientation is zero use parent orientation. (Some of the leaf joint orientations</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// are zero)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#4ec9b0">JointOrientation</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">orientation</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">v4</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">XMFLOAT4</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">X</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Y</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Z</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">W</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">parent</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">Parent</span><span style="background:#1e1e1e;color:#b4b4b4">();</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">XMVector4Equal</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">XMLoadFloat4</span><span style="background:#1e1e1e;color:#b4b4b4">(&amp;</span><span style="background:#1e1e1e;color:#c8c8c8">v4</span><span style="background:#1e1e1e;color:#b4b4b4">),</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMVectorZero</span><span style="background:#1e1e1e;color:#b4b4b4">())</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">&amp;&amp;</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">parent</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">nullptr</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">orientation</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">parent</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_orientation</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Create a rotation matrix from the orientation quaternion. If we are at the root start with a transform</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// to take us to the absolute position of the whole body. If we are not at the root start with the </span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// parent&#39;s transform.</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">f4</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">XMFLOAT4</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">X</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Y</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span></li> <li>                   <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Z</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Orientation</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">W</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">rotMatrix</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMMatrixRotationQuaternion</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">XMLoadFloat4</span><span style="background:#1e1e1e;color:#b4b4b4">(&amp;</span><span style="background:#1e1e1e;color:#c8c8c8">f4</span><span style="background:#1e1e1e;color:#b4b4b4">));</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">parent</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">nullptr</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">transformed</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">parent</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_transformed</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">else</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// We are at the root so transform to the absolute position (this transform will affect all bones in</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// the hierarchy)</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">pos</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">body</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">Joints</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">Lookup</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">JointType</span><span style="background:#1e1e1e;color:#b4b4b4">()).</span><span style="background:#1e1e1e;color:#dadada">Position</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">v3</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">XMFLOAT3</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#bd63c5">FACTOR</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">pos</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">X</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#bd63c5">FACTOR</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">pos</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Y</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#bd63c5">FACTOR</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">pos</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">Z</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">transformed</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMLoadFloat3</span><span style="background:#1e1e1e;color:#b4b4b4">(&amp;</span><span style="background:#1e1e1e;color:#c8c8c8">v3</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Convert the vector into a transform matrix and store into the model matrix</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">translatedOrigin</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMMatrixTranslationFromVector</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">transformed</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">XMStoreFloat</span><span style="background:#1e1e1e;color:#b4b4b4">(&amp;</span><span style="background:#1e1e1e;color:#dadada">m_constantBufferData</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">model</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMMatrixTranspose</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">translatedOrigin</span><span style="background:#1e1e1e;color:#b4b4b4">));</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// draw a marker here so we can see that we are in the right place (this should be at the end of the </span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// parent bone)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">DrawAxis</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">context</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#dadada">_axis</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#c8c8c8">get</span><span style="background:#1e1e1e;color:#b4b4b4">());</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">translated</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMMatrixTranslation</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#b5cea8">0.0</span><span style="background:#1e1e1e;color:#dcdcdc">f</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">boneLength</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b5cea8">0.0</span><span style="background:#1e1e1e;color:#dcdcdc">f</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">scaleMat</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMMatrixScaling</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#b5cea8">1.0</span><span style="background:#1e1e1e;color:#dcdcdc">f</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">BoneLength</span><span style="background:#1e1e1e;color:#b4b4b4">(),</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b5cea8">1.0</span><span style="background:#1e1e1e;color:#dcdcdc">f</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">mat</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">scaleMat</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">rotMatrix</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">*</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">translatedOrigin</span><span style="background:#1e1e1e;color:#b4b4b4">;</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">XMStoreFloat</span><span style="background:#1e1e1e;color:#b4b4b4">(&amp;</span><span style="background:#1e1e1e;color:#dadada">m_constantBufferData</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dadada">model</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMMatrixTranspose</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">mat</span><span style="background:#1e1e1e;color:#b4b4b4">));</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span></li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">auto</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">f3</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">XMFLOAT3</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#b5cea8">0.0</span><span style="background:#1e1e1e;color:#dcdcdc">f</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">boneLength</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b5cea8">0.0</span><span style="background:#1e1e1e;color:#dcdcdc">f</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#dadada">_transformed</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">XMVector3TransformCoord</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">XMLoadFloat3</span><span style="background:#1e1e1e;color:#b4b4b4">(&amp;</span><span style="background:#1e1e1e;color:#c8c8c8">f3</span><span style="background:#1e1e1e;color:#b4b4b4">),</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#c8c8c8">mat</span><span style="background:#1e1e1e;color:#b4b4b4">);</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">parent</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">nullptr</span><span style="background:#1e1e1e;color:#b4b4b4">)</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// draw...</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#c8c8c8">DrawBone</span><span style="background:#1e1e1e;color:#b4b4b4">(</span><span style="background:#1e1e1e;color:#c8c8c8">context</span><span style="background:#1e1e1e;color:#b4b4b4">,</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#7f7f7f">t</span><span style="background:#1e1e1e;color:#b4b4b4">-&gt;</span><span style="background:#1e1e1e;color:#c8c8c8">getColour</span><span style="background:#1e1e1e;color:#b4b4b4">());</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>and this shows the end result:</p> <p><a href="{{ site.baseurl }}/assets/images/2015/04/finalskeleton.png"><img title="finalskeleton" style="border-left-width: 0px; border-right-width: 0px; border-bottom-width: 0px; display: inline; border-top-width: 0px" border="0" alt="finalskeleton" src="{{ site.baseurl }}/assets/images/2015/04/finalskeleton_thumb.png" width="727" height="459"></a></p> <p>The sample code for this post is on Github here <a title="https://github.com/peted70/kinectv2-avateer-jointorientations" href="https://github.com/peted70/kinectv2-avateer-jointorientations">https://github.com/peted70/kinectv2-avateer-jointorientations</a></p>
