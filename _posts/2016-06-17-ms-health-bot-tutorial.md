---
layout: single
title: MS Health Bot Tutorial
date: 2016-06-17 10:54
author_profile: true
comments: true
categories: [Uncategorized]
header:
    teaserlogo: 'assets/images/'
    teaser: 'assets/images/'
---
<p>This is a step-by-step guide to writing an Bot in C# using the Bot Framework Connector SDK .NET template. You will need to have collected some sleep data using a Microsoft Band and have had that synchronised up to the Microsoft cloud as this tutorial uses the Bot Framework to provide access to that data. <p>1) Install prerequisite software</p> <blockquote> <p>- Visual Studio 2015 (latest update) - you can download the community version here for free: <a href="http://www.visualstudio.com ">www.visualstudio.com </a> <p>- Important: Please update all VS extensions to their latest versions Tools-&gt;Extensions and Updates-&gt;Updates</p></blockquote> <p>2) Download and install the Bot Application template</p> <blockquote> <p>- Download the file from the direct download link <a href="http://aka.ms/bf-bc-vstemplate">here</a>: </p> <p>- Save the zip file to your Visual Studio 2015 templates directory which is traditionally in </p> <p>“%USERPROFILE%\Documents\Visual Studio 2015\Templates\ProjectTemplates\Visual C#"</p></blockquote> <p>3) Open Visual Studio</p> <p>4) Select File &gt; New &gt; Project and you should see the dialog below. In the tree view on the left select Installed &gt; Templates &gt; Visual C# and click on the search box on the right and type bot</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/filenewproject.png"><img title="filenewproject" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="filenewproject" src="{{ site.baseurl }}/assets/images/2016/06/filenewproject_thumb.png" width="737" height="462"></a></p> <p>4) Select the Bot Application template and type in MSHealthBot as the Name and click OK</p> <p>Visual Studio will now create and initialise your project.</p> <p>The project that is created consists of an <a href="http://www.asp.net/web-api" target="_blank">ASP.NET Web API</a> project which is already set up with the Microsoft.Bot.Connector <a href="https://www.nuget.org/" target="_blank">Nuget</a> package and a MessagesController API end point with some boiler-plate Bot code.</p> <blockquote> <p><a href="http://www.asp.net/web-api" target="_blank">ASP.NET Web API</a> is an ideal platform for building RESTful applications on the .NET Framework</p> <p><a href="https://www.nuget.org/" target="_blank">NuGet</a> is the package manager for the Microsoft development platform including .NET&nbsp; </p></blockquote> <p>This represents the back-end of your bot and where the business logic code for your bot will all reside. The other main part of the system would be the bot client and that would represent the interface to your end-user. An example of a bot client might be Skype or Slack where the user might type in questions for your bot to answer or it could a voice recognition agent; ultimately your bot can work with any client. The Microsoft Bot Framework provides us with an emulator so that we can develop and test our bot.so the next step is to become familiar with its usage. </p> <p>To install the Bot Framework Emulator, download it from <strong><a href="https://aka.ms/bf-bc-emulator">here</a></strong>.</p> <p>To set up the Bot Framework Emulator (please see <a href="http://docs.botframework.com/connector/getstarted/#getting-started-in-net">http://docs.botframework.com/connector/getstarted/#getting-started-in-net</a> for installation and set up instructions).</p> <p>Note that the link between the bot you are currently developing and the emulator are the <strong>App ID</strong> and <strong>App Secret</strong> values which you find in your project’s Web.Config file:</p><script src="https://gist.github.com/peted70/64a35fa9929fcf2a6886f5b97ad28990.js"></script> <p>This ensures that your bot can be authenticated but for the purpose of this tutorial you can use them as they are. Please follow the next steps to get the default bot up and running in the Bot Emulator:</p> <p>1) From Visual Studio select Debug &gt; Start Debugging or press F5. This will start an instance of IISExpress on your machine which will locally host your bot and will open a browser window. This should look like the following:</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/localhost.png"><img title="localhost" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="localhost" src="{{ site.baseurl }}/assets/images/2016/06/localhost_thumb.png" width="737" height="386"></a>&nbsp;</p> <p>2) Whilst that is running, run up the emulator and ensure that it is pointing to the correct localhost url including port number and with the path /api/messages and the App ID and App Secret set correctly. Compare with:</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/emulator-default-bot.png"><img title="emulator-default-bot" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="emulator-default-bot" src="{{ site.baseurl }}/assets/images/2016/06/emulator-default-bot_thumb.png" width="730" height="595"></a>&nbsp;</p> <p>3) Type ‘hi there’ into the emulator’s chat window and you should get the reply ‘you sent 8 characters’ and you will see some JSON metadata in the right-hand pane which is data from the client that you will have available from within your bot code. The reply you see comes directly from the code in your bot; compare with the default bot implementation.</p><script src="https://gist.github.com/peted70/941da73f59a617a83818f2abfd4d09ad.js"></script> <p>Now, let’s start to build up our own logic onto this baseline. The project will consume two external services; the Microsoft Health API and LUIS (Language Understanding Intelligent Service) so let’s consider each in turn:</p> <h2>Microsoft Health API</h2> <p><a href="https://developer.microsoftband.com/cloudAPI" target="_blank">This</a> is an API over data from your Microsoft Band. The way that it works is that when you use your Microsoft Band to monitor your sleep or running it stores the data locally in it’s flash memory. When you are near your mobile phone the data is synchronised to the phone and from the phone synchronised up to the Microsoft cloud. From there you can access your data via this <a href="https://dashboard.microsofthealth.com" target="_blank">web dashboard</a> or via the MS Health API. In order to access your data via the API you need to retrieve an OAuth 2 access token using a typical OAuth 2 authorisation code flow which typically requires browser-style redirects (see <a href="{{site.baseurl}}/band/microsoft/ms%20band/universal/uwp/win10/windows/winrt/2015/07/13/microsoft-health-api-uwp-sample.html" target="_blank">here</a> for more details). This poses a problem for a bot as it doesn’t have a browser window. None of the examples I had seen up to this point mentioned auth in terms of how would a bot user authenticate and authorise access to their data. Azure Active Directory auth allows web-browser-free auth using the OAuth2 client credentials flow to authorise an app but applications and APIs using Windows Live style application registration do not. Microsoft Health Cloud API uses “Microsoft account (formerly Live Id)” token-based OAuth (Open Authorization) 2.0 authentication and more specifically the OAuth 2.0 authorisation code flow which requires browser-style redirects which are not provided for by a typical Bot client. Since I specifically wanted to call the Health API this requires the user to give consent to access for the calling app – in order to support this we can implement the following flow:</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/authflow.png"><img title="authflow" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="authflow" src="{{ site.baseurl }}/assets/images/2016/06/authflow_thumb.png" width="741" height="277"></a></p> <p>Your bot will need to be registered as an OAuth 2.0 client:</p> <p>1) Navigate to the Microsoft account developer center <a href="https://account.live.com/developers/applications">https://account.live.com/developers/applications</a> in a browser. Click on Add App.</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/addliveapp.png"><img title="addliveapp" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="addliveapp" src="{{ site.baseurl }}/assets/images/2016/06/addliveapp_thumb.png" width="744" height="173"></a></p> <p>2) Create an app and call it MSHealthBot</p> <p>3) Make a note of the <strong>Application ID</strong></p> <p>4) Generate a new password and make a note of it</p> <p>5) Click <strong>Add Platform </strong>and select Web</p> <p>6) Enter a Rediirect Uri – use your bot’s base url and add /api/auth/receivetoken to it, e.g. <a title="http://localhost:3978/api/auth/receivetoken" href="http://localhost:3978/api/auth/receivetoken">http://localhost:3978/api/auth/receivetoken</a> (we will implement this endpoint in the bot Web API).</p> <p>7) Click Live SDK support</p> <p>8) Save the settings</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/authserversettings.png"><img title="authserversettings" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="authserversettings" src="{{ site.baseurl }}/assets/images/2016/06/authserversettings_thumb.png" width="738" height="502"></a></p> <p>9) Copy the following code into your Global.asax.cs file:</p><script src="https://gist.github.com/peted70/4a9e61209e2a3bd8d567f8460fb9a76d.js"></script> <p>10) Right-click the Controllers folder in the Solution Explorer and choose <strong>Add &gt; Class </strong>and name it AuthController. Replace the new files contents with the code below:</p> <p><script src="https://gist.github.com/peted70/6f61775cd521d49c3ade3ac6296bc47b.js"></script>Find any red squiggles in the file, put your cursor on them and press CTRL + . to resolve any missing namespace usings.</p> <blockquote> <p>Let’s take a moment to understand the code we just pasted in</p> <p>- the code we put into global.asax.cs is simply a convenient way to store the auth token in memory on the server. In a production system we could use secure cloud storage.</p> <p>- the AuthController code provides an endpoint to initiate an OAuth 2.0 authorization code flow and also a redirect uri to receive an auth code which can be exchanged for an access token </p></blockquote> <p>11) The code also relies on two other environment variables being set: MSHEALTHBOT_HEALTHAPI_CLIENTID &amp; MSHEALTHBOT_HEALTHAPI_CLIENTSECRET which can be copied from your app registration. To set the variables from your dev machine you can use the setx command from the command prompt with the value as the last parameter:</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/setx_thumb1.png"><img title="setx_thumb1" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="setx_thumb1" src="{{ site.baseurl }}/assets/images/2016/06/setx_thumb1_thumb.png" width="737" height="141"></a></p> <p>Using this technique set the MSHEALTHBOT_HEALTHAPI_CLIENTID variable to the App ID you noted down from the earlier step and set the MSHEALTHBOT_HEALTHAPI_CLIENTSECRET to the App Secret we also noted earlier.</p> <blockquote> <p>If the app is not authorised the bot will reply with a link</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/emulator_thumb4.png"><img title="emulator_thumb4" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="emulator_thumb4" src="{{ site.baseurl }}/assets/images/2016/06/emulator_thumb4_thumb.png" width="709" height="565"></a></p> <p>User clicks the link which will take them to authorisation server passing a unique ID from the Bot Framework</p> <p>The user authenticates by logging in and then gives consent through the standard OAuth consent dialog</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/liveidsignin_thumb1.png"><img title="liveidsignin_thumb1" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="liveidsignin_thumb1" src="{{ site.baseurl }}/assets/images/2016/06/liveidsignin_thumb1_thumb.png" width="355" height="517"></a><a href="{{ site.baseurl }}/assets/images/2016/06/consent_thumb1.png"><img title="consent_thumb1" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="consent_thumb1" src="{{ site.baseurl }}/assets/images/2016/06/consent_thumb1_thumb.png" width="301" height="517"></a></p> <p>The unique user id is passed to the redirect uri which I have implemented as part of my Bot Web API along with the Health API access token</p> <p>The bot Web API stores the access token and it’s related unique user id together</p> <p>Subsequent calls to the Health API can use the access token to make calls (will stop working if the access token expires as I didn’t implement refresh tokens)&nbsp;&nbsp; </p></blockquote> <p>Subsequently, we have the access token which we can send in the auth header for requests to the Health API.</p> <h3>Health API Helpers</h3> <p>We need some code to call the Health API so let’s bring that in next:</p> <p>1) Right-click on your project and select <strong>Add &gt; New Folder</strong> and name the folder Models</p> <p>2) Copy the code from here <a title="https://gist.githubusercontent.com/peted70/9e5db9148137f5b3f95e68517eda8b0e/raw/ee1cb88a4fd6e9276664e71ee576ca4d58d7027d/bot-mshealth-model" href="https://gist.githubusercontent.com/peted70/9e5db9148137f5b3f95e68517eda8b0e/raw/ee1cb88a4fd6e9276664e71ee576ca4d58d7027d/bot-mshealth-model" target="_blank">MS Health Model Code</a> and paste it into a new file named <strong>Model.cs</strong> inside the <strong>Models</strong> folder</p> <p>3) Next, add the two helper methods below which wrap the calls to the Health APIs:to your <strong>MessagesController</strong> class</p> <p><script src="https://gist.github.com/peted70/9700106d519bb7b749c35240136e814f.js"></script>Find the <strong>AuthenticationHeaderValue</strong> reference, put your cusrsor over it and press <strong>CTRL and .</strong> and then resolve the namespace<script src="https://gist.github.com/peted70/b3ed42aa14ea9324ed05b22d5b2c693b.js"></script></p> <p>4) Finally add the following private member variable to your <strong>MessagesController</strong> class&nbsp; </p> <p>&nbsp;</p><script src="https://gist.github.com/peted70/33d3f23a7b06ab0c99447efa8ff465d8.js"></script> <h2>LUIS</h2> <p>To be effective a bot needs to allow the user to communicate using language which is natural and as we know language can sometimes be imprecise, ambiguous and nuanced. Trying to create a fixed grammar that could deal with these aspects would soon become very complex and hard to maintain. Instead we can leverage machine learning techniques and LUIS provides us with a way to do this which is very easy to set up and use.</p> <p>1) Download the JSON file here <a title="https://github.com/peted70/ms-health-bot/blob/2bbdbd7ed311db0362f1f6d9c95ee489dee8544a/assets/MSHealthBot.json" href="https://github.com/peted70/ms-health-bot/blob/2bbdbd7ed311db0362f1f6d9c95ee489dee8544a/assets/MSHealthBot.json">https://github.com/peted70/ms-health-bot/blob/2bbdbd7ed311db0362f1f6d9c95ee489dee8544a/assets/MSHealthBot.json</a></p> <p>2) Navigate to <a title="https://www.luis.ai" href="https://www.luis.ai">https://www.luis.ai</a></p> <p>3) Choose <strong>New App</strong> with the option <strong>Import Existing Application</strong></p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/LUISImport.png"><img title="LUISImport" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="LUISImport" src="{{ site.baseurl }}/assets/images/2016/06/LUISImport_thumb.png" width="741" height="231"></a>&nbsp; </p> <p>4) Upload the JSON file here</p> <blockquote> <p>Note that this will import a LUIS model that I have already trained – for details about how this was done please see my previous <a href="{{site.baseurl}}/api/bot/health/microsoft/ms%20band/web%20api/2016/05/03/ms-health-api-bot.html">post</a>.</p></blockquote> <p>5) Once imported you will need to train the model so select your app and at the lower left of it’s property page click the <strong>train</strong> button</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/luisimporttrain.png"><img title="luisimporttrain" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="luisimporttrain" src="{{ site.baseurl }}/assets/images/2016/06/luisimporttrain_thumb.png" width="739" height="355"></a></p> <p>6) Once trained the publish button on the left will become enabled. Click <strong>publish</strong> followed by <strong>publish web service</strong></p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/luispublish.png"><img title="luispublish" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="luispublish" src="{{ site.baseurl }}/assets/images/2016/06/luispublish_thumb.png" width="731" height="228"></a></p> <p>7) Once published you will get back a url at which your LUIS service can be accessed. The url will include an id and a subscription key – these are used to monitor usage – if your key becomes compromised you can generate a new one here.</p> <p><a href="{{ site.baseurl }}/assets/images/2016/06/luisurl.png"><img title="luisurl" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="luisurl" src="{{ site.baseurl }}/assets/images/2016/06/luisurl_thumb.png" width="730" height="304"></a></p> <p>8) That’s it – you now have a web service which will enable you to carry out natural language processing and will recognise entities associated with the Health APIs such as sleep, run, walk, etc. and also to recognise points in time and time ranges such as last week, or a year ago, etc.</p> <h3>Calling the LUIS Web Service</h3> <p>1) Open your MessageController.cs class and place the following method somewhere inside the MessageController class:</p><script src="https://gist.github.com/peted70/4bf0584301c7d4d2750463a2da4fce12.js"></script> <blockquote> <p>Note that the App ID and App Secret for the LUIS web service are again accessed as environment variables so you will need to set them using setx as done previously for the Health API ID and Secret (see above).</p></blockquote> <h2>Bot Implementation</h2> <p>Now we have all of the moving parts to implement our health bot</p> <p>1) Introduce the in-memory credential store into the MessageController class – remove the existing contructor and paste the following code into the class:</p><script src="https://gist.github.com/peted70/c49ba6dc270b95ef13687c92a158100e.js"></script> <p>2) Replace the whole body of the Post method with:</p> <blockquote> <p><script src="https://gist.github.com/peted70/23abeab9c13a036368bf4744fd80c3dd.js"></script>This implements our auth logic described earlier and will return an auth url to the user if no token is stored for them</p></blockquote> <p>3) Next we will install the NodaTime Nuget package to help us to parse out some of the time formats used by the Health API responses. So right-click the <strong>References</strong> node in the Solution Explorer and choose <strong>Manage Nuget Packages</strong>. In the Nuget dialog that will open Click on the <strong>Browse</strong> tab and ensure that Include Pre-release is checked. Then search for <strong>NodaTime</strong>, click the list item and then choose the version <strong>2.0.0-alpha20150728</strong> and click <strong>install</strong>. </p> <p>4) Find the <strong>TODO</strong> comment from the previous step and replace it with the following code.</p><script src="https://gist.github.com/peted70/d54c6ac52eadc7156e2fe4055f373b06.js"></script> <p>The last piece of code implements one possible scenario using the sleep activity however it is not difficult to see how this could be extended to work for all of the activities supported by the Health API – that is left as an exercise for the reader!</p> <h2>Summary</h2> <p>This tutorial has illustrated how to put together a real-world, useful bot not just be providing a text input interface to an API but allowing the user to use their natural voice input to query the aggregated data. Hopefully, this will leave you with some ideas about how to implement a bot for your own scenario.</p>
