---
layout: post
title: Windows Phone 7, MVVM and TDD (Part 4 – Loading…)
date: 2010-05-05 19:27
author: peted70
comments: true
categories: [MVVM, TDD, Windows Phone 7]
---
<div id="msgcns!4F1B7368284539E5!244" class="bvMsg"><p>By Peter Daukintis</p> <p>I decided to explore the Service Locator pattern to implement handling of the busy indicator. This involves considering the busy indicator as a service which can be called upon by the view model. Again it is implemented behind an interface to support unit testing. The interface looks like this:</p><pre>    <span style="color:#eaeaac;">public interface </span><span style="color:#2b91af;">IBusyIndicator
    </span><span style="color:#d2d200;">&#123;
        </span><span style="color:#eaeaac;">void </span><span style="color:#f8ffc6;">Hide</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">object </span><span style="color:#f8ffc6;">token</span><span style="color:#d2d200;">);
        </span><span style="color:#eaeaac;">void </span><span style="color:#f8ffc6;">Show</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">object </span><span style="color:#f8ffc6;">token</span><span style="color:#d2d200;">);
    &#125;

</span></pre>
<p><a href="http://11011.net/software/vspaste"></a>I based this solution on this source <a href="http://www.orktane.com/Blog/post/2010/01/23/iPhone-Sudoku-in-Silverlight-using-MVVM.aspx">http://www.orktane.com/Blog/post/2010/01/23/iPhone-Sudoku-in-Silverlight-using-MVVM.aspx</a> although my implementation is slightly different. So, the idea is that I have a UserControl which implements the IBusyIndicator interface. The user control gets added into the visual tree via the xaml and is registered into a static service locator class. The view model can request the service interface and make calls into it. The runtime objects can be faked to support unit testing.</p>
<p>Here’s the very simple ServiceLocator:</p><pre>    <span style="color:#eaeaac;">public static class </span><span style="color:#f0dfaf;">ServiceLocator
    </span><span style="color:#d2d200;">&#123;
        </span><span style="color:#eaeaac;">private static </span><span style="color:#2b91af;">IBusyIndicator </span><span style="color:#f8ffc6;">_busyIndicator</span><span style="color:#d2d200;">;

        </span><span style="color:#eaeaac;">public static void </span><span style="color:#f8ffc6;">SetBusyIndicatorService</span><span style="color:#d2d200;">(</span><span style="color:#2b91af;">IBusyIndicator </span><span style="color:#f8ffc6;">busyIndicator</span><span style="color:#d2d200;">)
        &#123;
            </span><span style="color:#f8ffc6;">_busyIndicator </span><span style="color:#d2d200;">= </span><span style="color:#f8ffc6;">busyIndicator</span><span style="color:#d2d200;">;
        &#125;

        </span><span style="color:#eaeaac;">public static </span><span style="color:#2b91af;">IBusyIndicator </span><span style="color:#f8ffc6;">BusyIndicatorServiceStatic
        </span><span style="color:#d2d200;">&#123;
            </span><span style="color:#eaeaac;">get
            </span><span style="color:#d2d200;">&#123;
                </span><span style="color:#eaeaac;">return </span><span style="color:#f8ffc6;">_busyIndicator</span><span style="color:#d2d200;">;
            &#125;
        &#125;
    &#125;

</span></pre>
<p>With this new interface we can extend the Execute login command functionality. Calls to </p><pre>            <span style="color:#f0dfaf;">ServiceLocator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">BusyIndicatorServiceStatic</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">Show</span><span style="color:#d2d200;">(</span><span style="color:#f8ffc6;">_token</span><span style="color:#d2d200;">);

</span></pre><a href="http://11011.net/software/vspaste"></a>
<p>and the corresponding hide can be made in the Execute flow. Now, this will cause NullReference exceptions in the Login command tests so we’d better go and fix these up. The following line can be inserted before the view model creation in each test method that will execute the login command</p><pre>            <span style="color:#f0dfaf;">ServiceLocator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">SetBusyIndicatorService</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">new </span><span style="color:#f0dfaf;">FakeBusyIndicator</span><span style="color:#d2d200;">());

</span></pre>
<p><a href="http://11011.net/software/vspaste"></a>where FakeBusyIndicator is defined as follows:</p><pre>    <span style="color:#eaeaac;">public class </span><span style="color:#f0dfaf;">FakeBusyIndicator </span><span style="color:#d2d200;">: </span><span style="color:#2b91af;">IBusyIndicator
    </span><span style="color:#d2d200;">&#123;
        </span><span style="color:#dfaf8f;">#region </span><span style="color:#d2d200;">Implementation of IBusyIndicator

        </span><span style="color:#eaeaac;">public void </span><span style="color:#f8ffc6;">Hide</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">object </span><span style="color:#f8ffc6;">token</span><span style="color:#d2d200;">) &#123; &#125;
        </span><span style="color:#eaeaac;">public void </span><span style="color:#f8ffc6;">Show</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">object </span><span style="color:#f8ffc6;">token</span><span style="color:#d2d200;">) &#123; &#125;

        </span><span style="color:#dfaf8f;">#endregion
    </span><span style="color:#d2d200;">&#125;

</span></pre><a href="http://11011.net/software/vspaste"></a>
<p><span style="color:#d2d200;"><br /></span>Also, the addition of a mock busy indicator:</p><pre>    <span style="color:#eaeaac;">public class </span><span style="color:#f0dfaf;">MockBusyIndicator </span><span style="color:#d2d200;">: </span><span style="color:#2b91af;">IBusyIndicator
    </span><span style="color:#d2d200;">&#123;
        </span><span style="color:#eaeaac;">public int </span><span style="color:#f8ffc6;">HideCount </span><span style="color:#d2d200;">&#123; </span><span style="color:#eaeaac;">get</span><span style="color:#d2d200;">; </span><span style="color:#eaeaac;">private set</span><span style="color:#d2d200;">; &#125;
        </span><span style="color:#eaeaac;">public int </span><span style="color:#f8ffc6;">ShowCount </span><span style="color:#d2d200;">&#123; </span><span style="color:#eaeaac;">get</span><span style="color:#d2d200;">; </span><span style="color:#eaeaac;">private set</span><span style="color:#d2d200;">; &#125;

        </span><span style="color:#dfaf8f;">#region </span><span style="color:#d2d200;">Implementation of IBusyIndicator

        </span><span style="color:#eaeaac;">public void </span><span style="color:#f8ffc6;">Hide</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">object </span><span style="color:#f8ffc6;">token</span><span style="color:#d2d200;">) &#123; ++</span><span style="color:#f8ffc6;">HideCount</span><span style="color:#d2d200;">; &#125;
        </span><span style="color:#eaeaac;">public void </span><span style="color:#f8ffc6;">Show</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">object </span><span style="color:#f8ffc6;">token</span><span style="color:#d2d200;">) &#123; ++</span><span style="color:#f8ffc6;">ShowCount</span><span style="color:#d2d200;">; &#125;

        </span><span style="color:#dfaf8f;">#endregion
    </span><span style="color:#d2d200;">&#125;

</span></pre>
<p>enables the following unit test to be implemented.</p><pre>        <span style="color:#d2d200;">[</span><span style="color:#f0dfaf;">TestMethod</span><span style="color:#d2d200;">]
        [</span><span style="color:#f0dfaf;">Asynchronous</span><span style="color:#d2d200;">]
        </span><span style="color:#eaeaac;">public void </span><span style="color:#f8ffc6;">LoginCommand_ExecuteWithValidParameters_CausesCorrectBusyIndicatorShowHide</span><span style="color:#d2d200;">()
        &#123;
            </span><span style="color:#eaeaac;">var </span><span style="color:#f8ffc6;">fakeUserRepository </span><span style="color:#d2d200;">= </span><span style="color:#eaeaac;">new </span><span style="color:#f0dfaf;">FakeUserRepository</span><span style="color:#d2d200;">();

            </span><span style="color:#eaeaac;">var </span><span style="color:#f8ffc6;">mockBusyIndicator </span><span style="color:#d2d200;">= </span><span style="color:#eaeaac;">new </span><span style="color:#f0dfaf;">MockBusyIndicator</span><span style="color:#d2d200;">();
            </span><span style="color:#f0dfaf;">ServiceLocator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">SetBusyIndicatorService</span><span style="color:#d2d200;">(</span><span style="color:#f8ffc6;">mockBusyIndicator</span><span style="color:#d2d200;">);

            </span><span style="color:#eaeaac;">var </span><span style="color:#f8ffc6;">mainViewModel </span><span style="color:#d2d200;">= </span><span style="color:#eaeaac;">new </span><span style="color:#f0dfaf;">MainViewModel</span><span style="color:#d2d200;">(</span><span style="color:#f8ffc6;">fakeUserRepository</span><span style="color:#d2d200;">) &#123; </span><span style="color:#f8ffc6;">UsernameText </span><span style="color:#d2d200;">= </span><span style="color:#c89191;">&quot;user&quot;</span><span style="color:#d2d200;">, </span><span style="color:#f8ffc6;">PasswordText </span><span style="color:#d2d200;">= </span><span style="color:#c89191;">&quot;pwd&quot; </span><span style="color:#d2d200;">&#125;;
            </span><span style="color:#f8ffc6;">mainViewModel</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">LoginCommand</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">Execute</span><span style="color:#d2d200;">(</span><span style="color:#eaeaac;">null</span><span style="color:#d2d200;">);

            </span><span style="color:#f8ffc6;">EnqueueConditional</span><span style="color:#d2d200;">(() =&gt; </span><span style="color:#f8ffc6;">mainViewModel</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">IsLoading </span><span style="color:#d2d200;">== </span><span style="color:#eaeaac;">false</span><span style="color:#d2d200;">);
            </span><span style="color:#f8ffc6;">EnqueueCallback</span><span style="color:#d2d200;">(() =&gt; </span><span style="color:#f0dfaf;">Assert</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">IsTrue</span><span style="color:#d2d200;">(</span><span style="color:#f8ffc6;">mockBusyIndicator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">HideCount </span><span style="color:#d2d200;">&gt; </span><span style="color:#8acccf;">0 </span><span style="color:#d2d200;">&amp;&amp; </span><span style="color:#f8ffc6;">mockBusyIndicator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">ShowCount </span><span style="color:#d2d200;">&gt; </span><span style="color:#8acccf;">0 </span><span style="color:#d2d200;">&amp;&amp;
                </span><span style="color:#f8ffc6;">mockBusyIndicator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">HideCount </span><span style="color:#d2d200;">== </span><span style="color:#f8ffc6;">mockBusyIndicator</span><span style="color:#d2d200;">.</span><span style="color:#f8ffc6;">ShowCount</span><span style="color:#d2d200;">));
            </span><span style="color:#f8ffc6;">EnqueueTestComplete</span><span style="color:#d2d200;">();
        &#125;

</span></pre>
<p>A quick run of the test project shows all tests pass!</p>
<p><a href="https://omlweq.bay.livefilestore.com/y1mjQ_8Qv7qpjVISVIR6eSSKpKHVgdahf-U1uwzYnB5PQAnH1yWJOU1JrWQHfTHykxq4B1HKUMEqlvWd9ltQg98VN6pLvEUKMlMlvzAjqMY5N5Bt65poKFdxnpjWyTYg_hgxRcAT8hlriLq5O3-vdLogg/WP7LoginAllSuccess5.png" rel="WLPP"><img style="display:block;float:none;margin-left:auto;margin-right:auto;border-width:0;" title="WP7LoginAllSuccess" border="0" alt="WP7LoginAllSuccess" src="http://peted.azurewebsites.net/wp-content/uploads/2010/09/wp7loginallsuccess_thumb3.png?w=172" width="399" height="692" /></a> </p>
<p>So, that’s about it for the view model and the unit tests – next for the fun bit of creating the user interface and wiring up the data-binding of the view model.</p>
<p></p>Technorati Tags: <a href="http://technorati.com/tags/MVVM" rel="tag">MVVM</a>,<a href="http://technorati.com/tags/Part" rel="tag">Part</a>,<a href="http://technorati.com/tags/Peter" rel="tag">Peter</a>,<a href="http://technorati.com/tags/Daukintis" rel="tag">Daukintis</a>,<a href="http://technorati.com/tags/Service" rel="tag">Service</a>,<a href="http://technorati.com/tags/Locator" rel="tag">Locator</a>,<a href="http://technorati.com/tags/indicator" rel="tag">indicator</a>,<a href="http://technorati.com/tags/Again" rel="tag">Again</a>,<a href="http://technorati.com/tags/interface" rel="tag">interface</a>,<a href="http://technorati.com/tags/unit" rel="tag">unit</a>,<a href="http://technorati.com/tags/IBusyIndicator" rel="tag">IBusyIndicator</a>,<a href="http://technorati.com/tags/Hide" rel="tag">Hide</a>,<a href="http://technorati.com/tags/solution" rel="tag">solution</a>,<a href="http://technorati.com/tags/Blog" rel="tag">Blog</a>,<a href="http://technorati.com/tags/Sudoku" rel="tag">Sudoku</a>,<a href="http://technorati.com/tags/implementation" rel="tag">implementation</a>,<a href="http://technorati.com/tags/UserControl" rel="tag">UserControl</a>,<a href="http://technorati.com/tags/implements" rel="tag">implements</a>,<a href="http://technorati.com/tags/user" rel="tag">user</a>,<a href="http://technorati.com/tags/tree" rel="tag">tree</a>,<a href="http://technorati.com/tags/objects" rel="tag">objects</a>,<a href="http://technorati.com/tags/Here" rel="tag">Here</a>,<a href="http://technorati.com/tags/ServiceLocator" rel="tag">ServiceLocator</a>,<a href="http://technorati.com/tags/_busyIndicator" rel="tag">_busyIndicator</a>,<a href="http://technorati.com/tags/SetBusyIndicatorService" rel="tag">SetBusyIndicatorService</a>,<a href="http://technorati.com/tags/BusyIndicatorServiceStatic" rel="tag">BusyIndicatorServiceStatic</a>,<a href="http://technorati.com/tags/Execute" rel="tag">Execute</a>,<a href="http://technorati.com/tags/_token" rel="tag">_token</a>,<a href="http://technorati.com/tags/NullReference" rel="tag">NullReference</a>,<a href="http://technorati.com/tags/Login" rel="tag">Login</a>,<a href="http://technorati.com/tags/creation" rel="tag">creation</a>,<a href="http://technorati.com/tags/method" rel="tag">method</a>,<a href="http://technorati.com/tags/FakeBusyIndicator" rel="tag">FakeBusyIndicator</a>,<a href="http://technorati.com/tags/region" rel="tag">region</a>,<a href="http://technorati.com/tags/Also" rel="tag">Also</a>,<a href="http://technorati.com/tags/addition" rel="tag">addition</a>,<a href="http://technorati.com/tags/MockBusyIndicator" rel="tag">MockBusyIndicator</a>,<a href="http://technorati.com/tags/HideCount" rel="tag">HideCount</a>,<a href="http://technorati.com/tags/ShowCount" rel="tag">ShowCount</a>,<a href="http://technorati.com/tags/TestMethod" rel="tag">TestMethod</a>,<a href="http://technorati.com/tags/Asynchronous" rel="tag">Asynchronous</a>,<a href="http://technorati.com/tags/LoginCommand_ExecuteWithValidParameters_CausesCorrectBusyIndicatorShowHide" rel="tag">LoginCommand_ExecuteWithValidParameters_CausesCorrectBusyIndicatorShowHide</a>,<a href="http://technorati.com/tags/FakeUserRepository" rel="tag">FakeUserRepository</a>,<a href="http://technorati.com/tags/MainViewModel" rel="tag">MainViewModel</a>,<a href="http://technorati.com/tags/UsernameText" rel="tag">UsernameText</a>,<a href="http://technorati.com/tags/PasswordText" rel="tag">PasswordText</a>,<a href="http://technorati.com/tags/LoginCommand" rel="tag">LoginCommand</a>,<a href="http://technorati.com/tags/EnqueueConditional" rel="tag">EnqueueConditional</a>,<a href="http://technorati.com/tags/EnqueueCallback" rel="tag">EnqueueCallback</a>,<a href="http://technorati.com/tags/Assert" rel="tag">Assert</a>,<a href="http://technorati.com/tags/IsTrue" rel="tag">IsTrue</a>,<a href="http://technorati.com/tags/EnqueueTestComplete" rel="tag">EnqueueTestComplete</a>,<a href="http://technorati.com/tags/data" rel="tag">data</a>,<a href="http://technorati.com/tags/busyIndicator" rel="tag">busyIndicator</a>,<a href="http://technorati.com/tags/endregion" rel="tag">endregion</a><br />
<p></p>Windows Live Tags: <a href="http://windows.live.com/connect/tag/MVVM" rel="clubhouseTag">MVVM</a>,<a href="http://windows.live.com/connect/tag/Part" rel="clubhouseTag">Part</a>,<a href="http://windows.live.com/connect/tag/Peter" rel="clubhouseTag">Peter</a>,<a href="http://windows.live.com/connect/tag/Daukintis" rel="clubhouseTag">Daukintis</a>,<a href="http://windows.live.com/connect/tag/Service" rel="clubhouseTag">Service</a>,<a href="http://windows.live.com/connect/tag/Locator" rel="clubhouseTag">Locator</a>,<a href="http://windows.live.com/connect/tag/indicator" rel="clubhouseTag">indicator</a>,<a href="http://windows.live.com/connect/tag/Again" rel="clubhouseTag">Again</a>,<a href="http://windows.live.com/connect/tag/interface" rel="clubhouseTag">interface</a>,<a href="http://windows.live.com/connect/tag/unit" rel="clubhouseTag">unit</a>,<a href="http://windows.live.com/connect/tag/IBusyIndicator" rel="clubhouseTag">IBusyIndicator</a>,<a href="http://windows.live.com/connect/tag/Hide" rel="clubhouseTag">Hide</a>,<a href="http://windows.live.com/connect/tag/solution" rel="clubhouseTag">solution</a>,<a href="http://windows.live.com/connect/tag/Blog" rel="clubhouseTag">Blog</a>,<a href="http://windows.live.com/connect/tag/Sudoku" rel="clubhouseTag">Sudoku</a>,<a href="http://windows.live.com/connect/tag/implementation" rel="clubhouseTag">implementation</a>,<a href="http://windows.live.com/connect/tag/UserControl" rel="clubhouseTag">UserControl</a>,<a href="http://windows.live.com/connect/tag/implements" rel="clubhouseTag">implements</a>,<a href="http://windows.live.com/connect/tag/user" rel="clubhouseTag">user</a>,<a href="http://windows.live.com/connect/tag/tree" rel="clubhouseTag">tree</a>,<a href="http://windows.live.com/connect/tag/objects" rel="clubhouseTag">objects</a>,<a href="http://windows.live.com/connect/tag/Here" rel="clubhouseTag">Here</a>,<a href="http://windows.live.com/connect/tag/ServiceLocator" rel="clubhouseTag">ServiceLocator</a>,<a href="http://windows.live.com/connect/tag/_busyIndicator" rel="clubhouseTag">_busyIndicator</a>,<a href="http://windows.live.com/connect/tag/SetBusyIndicatorService" rel="clubhouseTag">SetBusyIndicatorService</a>,<a href="http://windows.live.com/connect/tag/BusyIndicatorServiceStatic" rel="clubhouseTag">BusyIndicatorServiceStatic</a>,<a href="http://windows.live.com/connect/tag/Execute" rel="clubhouseTag">Execute</a>,<a href="http://windows.live.com/connect/tag/_token" rel="clubhouseTag">_token</a>,<a href="http://windows.live.com/connect/tag/NullReference" rel="clubhouseTag">NullReference</a>,<a href="http://windows.live.com/connect/tag/Login" rel="clubhouseTag">Login</a>,<a href="http://windows.live.com/connect/tag/creation" rel="clubhouseTag">creation</a>,<a href="http://windows.live.com/connect/tag/method" rel="clubhouseTag">method</a>,<a href="http://windows.live.com/connect/tag/FakeBusyIndicator" rel="clubhouseTag">FakeBusyIndicator</a>,<a href="http://windows.live.com/connect/tag/region" rel="clubhouseTag">region</a>,<a href="http://windows.live.com/connect/tag/Also" rel="clubhouseTag">Also</a>,<a href="http://windows.live.com/connect/tag/addition" rel="clubhouseTag">addition</a>,<a href="http://windows.live.com/connect/tag/MockBusyIndicator" rel="clubhouseTag">MockBusyIndicator</a>,<a href="http://windows.live.com/connect/tag/HideCount" rel="clubhouseTag">HideCount</a>,<a href="http://windows.live.com/connect/tag/ShowCount" rel="clubhouseTag">ShowCount</a>,<a href="http://windows.live.com/connect/tag/TestMethod" rel="clubhouseTag">TestMethod</a>,<a href="http://windows.live.com/connect/tag/Asynchronous" rel="clubhouseTag">Asynchronous</a>,<a href="http://windows.live.com/connect/tag/LoginCommand_ExecuteWithValidParameters_CausesCorrectBusyIndicatorShowHide" rel="clubhouseTag">LoginCommand_ExecuteWithValidParameters_CausesCorrectBusyIndicatorShowHide</a>,<a href="http://windows.live.com/connect/tag/FakeUserRepository" rel="clubhouseTag">FakeUserRepository</a>,<a href="http://windows.live.com/connect/tag/MainViewModel" rel="clubhouseTag">MainViewModel</a>,<a href="http://windows.live.com/connect/tag/UsernameText" rel="clubhouseTag">UsernameText</a>,<a href="http://windows.live.com/connect/tag/PasswordText" rel="clubhouseTag">PasswordText</a>,<a href="http://windows.live.com/connect/tag/LoginCommand" rel="clubhouseTag">LoginCommand</a>,<a href="http://windows.live.com/connect/tag/EnqueueConditional" rel="clubhouseTag">EnqueueConditional</a>,<a href="http://windows.live.com/connect/tag/EnqueueCallback" rel="clubhouseTag">EnqueueCallback</a>,<a href="http://windows.live.com/connect/tag/Assert" rel="clubhouseTag">Assert</a>,<a href="http://windows.live.com/connect/tag/IsTrue" rel="clubhouseTag">IsTrue</a>,<a href="http://windows.live.com/connect/tag/EnqueueTestComplete" rel="clubhouseTag">EnqueueTestComplete</a>,<a href="http://windows.live.com/connect/tag/data" rel="clubhouseTag">data</a>,<a href="http://windows.live.com/connect/tag/busyIndicator" rel="clubhouseTag">busyIndicator</a>,<a href="http://windows.live.com/connect/tag/endregion" rel="clubhouseTag">endregion</a>  </div>
