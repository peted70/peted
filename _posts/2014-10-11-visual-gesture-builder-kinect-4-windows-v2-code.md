---
layout: single
title: Visual Gesture Builder &ndash; Kinect 4 Windows v2 (code)
date: 2014-10-11 14:51
author_profile: true
comments: true
categories: [Kinect]
header:
    teaserlogo: 'assets/images/'
    teaser: 'assets/images/'
---
<p>My previous <a href="{{site.baseurl}}/kinect/2014/10/03/visual-gesture-builder-kinect-4-windows-v2.html">post</a> looked into my experimentation with using Visual Gesture Builder to create a gesture builder database (gbd) with a view to incorporating code into an application for detecting those trained gestures. I used the example of a military salute and will now describe the code for using this in a c#/xaml windows store app. I started by using some boilerplate code from a previous <a href="{{site.baseurl}}/kinect/rx/winrt/2014/08/17/face-tracking-kinect-4-windows-v2.html">post</a> which registers events to receive skeleton data (required for gesture detection) and colour data (to display the colour image from the RGB camera). </p> <p>&nbsp;</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:0c1f5c23-db81-4d5f-81ba-fc68fdadcda4" class="wlWriterEditableSmartContent" style="width: 566px; float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; margin-right: auto"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc">_gestureDatabase </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">new</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">VisualGestureBuilderDatabase</span><span style="background:#1e1e1e;color:#dcdcdc">(</span><span style="background:#1e1e1e;color:#d69d85">@&quot;Gestures/salute.gbd&quot;</span><span style="background:#1e1e1e;color:#dcdcdc">);</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameSource </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">new</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#4ec9b0">VisualGestureBuilderFrameSource</span><span style="background:#1e1e1e;color:#dcdcdc">(_kinect, </span><span style="background:#1e1e1e;color:#b5cea8">0</span><span style="background:#1e1e1e;color:#dcdcdc">);</span></li> <li>&nbsp;</li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#57a64a">// Add all gestures in the database to the framesource..</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AddGestures(_gestureDatabase</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AvailableGestures);</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">foreach</span><span style="background:#1e1e1e;color:#dcdcdc"> (</span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> gesture </span><span style="background:#1e1e1e;color:#569cd6">in</span><span style="background:#1e1e1e;color:#dcdcdc"> _gestureDatabase</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AvailableGestures)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (gesture</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Name </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#d69d85">&quot;salute&quot;</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc">_salute </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> gesture;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (gesture</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Name </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#d69d85">&quot;saluteProgress&quot;</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc">_saluteProgress </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> gesture;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even">&nbsp;</li> <li><span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameReader </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> _gestureFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">OpenReader();</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">IsPaused </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">true</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameArrived </span><span style="background:#1e1e1e;color:#b4b4b4">+=</span><span style="background:#1e1e1e;color:#dcdcdc"> reader_FrameArrived;</span></li> </ol> </div> </div> </div> <p>&nbsp;</p> <p>This snippet shows the initialisation code for importing the gesture database and registering to receive events when new data arrives.Note that I hold references to Gesture objects so that I can identify these when the data arrives.The two gestures I am interested in are the “salute” gesture which is a discrete gesture and “saluteProgress” which is a continuous gesture and will report progress for the salute. (Note. details of what, how and why for those different gesture types are in my previous <a href="{{site.baseurl}}/kinect/2014/10/03/visual-gesture-builder-kinect-4-windows-v2.html">post</a>). This code follows the familiar pattern followed by the Kinect SDK of creating a frame source and opening a reader on that source which can be used to register for data events.Since we need a tracking id for gesture detection I have paused the reader until we have a valid one (this will be retrieved from the skeleton data, see code snippet below).</p> <p>&nbsp;</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:09c47653-0fdf-4a47-ad98-d1ba3db7f3c9" class="wlWriterEditableSmartContent" style="width: 386px; float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; margin-right: auto"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (body </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">&amp;&amp;</span><span style="background:#1e1e1e;color:#dcdcdc"> body</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">IsTracked)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameSource</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">TrackingId </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> body</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">TrackingId;</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">_gestureFrameReader</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">IsPaused </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">false</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">break</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>&nbsp;</p> <p>When the gesture data arrives, info about the current status of each gesture can be pulled out if the frame and in my sample I just display these on simple UI elements.</p> <p>&nbsp;</p> <div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:f79c7cb7-3eff-4e09-b5ed-cc1b6f69a92b" class="wlWriterEditableSmartContent" style="width: 999px; float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; margin-right: auto"> <div class="le-pavsc-container"> <div style="background: #ddd; overflow: auto"> <ol start="1" style="background: #000000; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">void</span><span style="background:#1e1e1e;color:#dcdcdc"> reader_FrameArrived(</span><span style="background:#1e1e1e;color:#4ec9b0">VisualGestureBuilderFrameReader</span><span style="background:#1e1e1e;color:#dcdcdc"> sender, </span><span style="background:#1e1e1e;color:#4ec9b0">VisualGestureBuilderFrameArrivedEventArgs</span><span style="background:#1e1e1e;color:#dcdcdc"> args)</span></li> <li class="le-pavsc-even"><span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>    <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">using</span><span style="background:#1e1e1e;color:#dcdcdc"> (</span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> frame </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> args</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">FrameReference</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">AcquireFrame())</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (frame </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b4b4b4">&amp;&amp;</span><span style="background:#1e1e1e;color:#dcdcdc"> frame</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">DiscreteGestureResults </span><span style="background:#1e1e1e;color:#b4b4b4">!=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">null</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">        <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>            <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> result </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> frame</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">DiscreteGestureResults[_salute];</span></li> <li class="le-pavsc-even">            <span style="background:#1e1e1e;color:#dcdcdc"></span></li> <li>            <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">if</span><span style="background:#1e1e1e;color:#dcdcdc"> (result</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Detected </span><span style="background:#1e1e1e;color:#b4b4b4">==</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#569cd6">true</span><span style="background:#1e1e1e;color:#dcdcdc">)</span></li> <li class="le-pavsc-even">            <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li>                <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">var</span><span style="background:#1e1e1e;color:#dcdcdc"> progressResult </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> frame</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">ContinuousGestureResults[_saluteProgress];</span></li> <li class="le-pavsc-even">                <span style="background:#1e1e1e;color:#dcdcdc">Progress</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Value </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> progressResult</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Progress;</span></li> <li>            <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even">            <span style="background:#1e1e1e;color:#dcdcdc"></span><span style="background:#1e1e1e;color:#569cd6">else</span></li> <li>            <span style="background:#1e1e1e;color:#dcdcdc">{</span></li> <li class="le-pavsc-even">                <span style="background:#1e1e1e;color:#dcdcdc">Progress</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Value </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#b5cea8">0.0</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li>            <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even">&nbsp;</li> <li>            <span style="background:#1e1e1e;color:#dcdcdc">GestureText</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Text </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> result</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Detected </span><span style="background:#1e1e1e;color:#b4b4b4">?</span><span style="background:#1e1e1e;color:#dcdcdc"> </span><span style="background:#1e1e1e;color:#d69d85">&quot;TRUE&quot;</span><span style="background:#1e1e1e;color:#dcdcdc"> : </span><span style="background:#1e1e1e;color:#d69d85">&quot;FALSE&quot;</span><span style="background:#1e1e1e;color:#dcdcdc">;</span></li> <li class="le-pavsc-even">            <span style="background:#1e1e1e;color:#dcdcdc">ConfidenceText</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Text </span><span style="background:#1e1e1e;color:#b4b4b4">=</span><span style="background:#1e1e1e;color:#dcdcdc"> result</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">Confidence</span><span style="background:#1e1e1e;color:#b4b4b4">.</span><span style="background:#1e1e1e;color:#dcdcdc">ToString();</span></li> <li>        <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li class="le-pavsc-even">    <span style="background:#1e1e1e;color:#dcdcdc">}</span></li> <li><span style="background:#1e1e1e;color:#dcdcdc">}</span></li> </ol> </div> </div> </div> <p>&nbsp;</p> <p>Here’s a screenshot of the sample in action:</p> <p>&nbsp;</p> <p><a href="{{ site.baseurl }}/assets/images/2014/10/salutesmall.png"><img title="salutesmall" style="border-top: 0px; border-right: 0px; border-bottom: 0px; float: none; margin-left: auto; border-left: 0px; display: block; margin-right: auto" border="0" alt="salutesmall" src="{{ site.baseurl }}/assets/images/2014/10/salutesmall_thumb.png" width="548" height="480"></a> </p> <p>The sample project is located here <a title="http://1drv.ms/1C4RQGU" href="http://1drv.ms/1C4RQGU">http://1drv.ms/1C4RQGU</a></p>
